---
title: "Travel Diffs"
author: "Angela"
date: '2023-04-05'
output: html_document
---

```{r}
library(tidyverse)
library(lubridate)
library(cowplot)

trav.data<-"Data/24100056-eng/24100056.csv"
# https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=2410005601&cubeTimeFrame.startDaily=2020-12-01&cubeTimeFrame.endDaily=2021-01-31&referencePeriods=20201201%2C20210131

# trav.data.big<-"Data/24100053-eng/24100053.csv" #huge one with all land and air, back to 1972..

fold.out<-"Results_202305/"
fold.out2<-"Results/ExpectedTravelVolume_Final_202305/" 

if(!dir.exists(fold.out)){dir.create(fold.out)}
if(!dir.exists(fold.out2)){dir.create(fold.out2)}

pubTheme<-theme(panel.background=element_rect("grey95"), 
                axis.line = element_line(colour = "black"),
                legend.key.size = unit(0.5,"line"),
                text=element_text(size=10,face="bold"),
                legend.text=element_text(size=7),
                axis.text.x=element_text(angle=45, hjust=1,vjust=1))

scaleDate<-scale_x_date(date_breaks = "1 month", date_minor_breaks = "1 month", 
                        date_labels = "%b %Y",expand=c(0,0))

scaleDateYr<-scale_x_date(date_breaks = "6 months", date_minor_breaks = "1 month", 
                        date_labels = "%b %Y",expand=c(0,0))

```

#read in the data and inspect
```{r}
dat1<-read.csv(trav.data) 
# dat2<-read.csv(trav.data.big) 

nrow(dat1) #4,197,788
dat1$REF_DATE<-as.Date(dat1$REF_DATE)
range(dat1$REF_DATE) #"2018-01-01" "2023-02-28"
table(dat1$Country.of.residence)
table(dat1$GEO) #airport of entry
table(dat1$Traveller.type)
table(dat1$VALUE) # number of travellers 

#remove unnecc cols
trav<-dat1[,c("REF_DATE","Country.of.residence","GEO","Traveller.type","VALUE")]

#note that visitors encapsulates all the arrivals, only some of which were overnight (most) and some were same-day
#since we arent' stratifying by airport, just filter to geo==canada
trav<-trav %>% 
  filter (Traveller.type=="Visitors") %>% 
  filter(GEO=="Canada")
  

#make  new columns for year and year month
trav$year<-format(trav$REF_DATE,"%Y")
trav$month<-format(trav$REF_DATE,"%b")
trav$monthyear<-format(trav$REF_DATE,"%b %Y")
trav$date<-as.Date(paste0(format(trav$REF_DATE,"%Y-%m"),"-01")) #note this is not the real date but a plotting trick for months. Use REF DATE for day

table(trav$Country.of.residence)
```


# Look at global trends in travel
```{r}
# unique(trav$Country.of.residence)

#note that some of these are redundant
big.redund<-c("International visitors entering or returning to Canada, air" ,
"Non-resident visitors entering Canada, air" ,                                         
"Residents of countries other than the United States of America entering Canada, air", 
"Canadian-resident visitors returning to Canada, air"  ,                            
"Canadian residents returning from the United States of America, air",                    
"Canadian residents returning from countries other than the United States of America, air")

contin<-c("Europe","Asia","Americas, countries other than the United States of America",
          "Oceania","Africa","Antarctica and Adjacent Islands - all countries")

#look at 2021 only
trav.2021<-trav %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31"))

#overall ranking
trav.2021.sums<-trav.2021 %>% 
  filter(!Country.of.residence %in% big.redund) %>%
  filter(!Country.of.residence %in% contin) %>%

  group_by(Country.of.residence) %>%
  summarise(.groups="rowwise",
            sumvalue=sum(VALUE)) %>%
  as.data.frame()
trav.2021.sums<-trav.2021.sums[with(trav.2021.sums, order(-sumvalue)),]
head(trav.2021.sums,n=10)

#look at overall trends
# trav.2021 %>%
#   filter(!Country.of.residence %in% big.redund) %>%  
#   filter(!Country.of.residence %in% contin) %>%
#   filter(!Country.of.residence %in% "United States of America residents entering Canada, air") %>%
#   ggplot()+
#   geom_histogram(aes(x=REF_DATE, y=VALUE, group=Country.of.residence, color=Country.of.residence),stat="identity",binwidth = 1)+
#   theme(legend.position = "none")

#look at changes in Canadian travel
# "International visitors entering or returning to Canada, air" ,
# "Non-resident visitors entering Canada, air" ,                                         
# "Residents of countries other than the United States of America entering Canada, air", 
# 
# try<-"International visitors entering or returning to Canada, air"
residences<-c("Non-resident visitors entering Canada, air","Canadian-resident visitors returning to Canada, air")
library(zoo)
# max(trav.2021$VALUE) 47433
# i<-which(trav.2021$VALUE==max(trav.2021$VALUE))
# trav.2021[i,]
p.3a<-trav.2021 %>% 
  filter(Country.of.residence%in% residences )%>%
  ggplot()+
  geom_bar(aes(x=REF_DATE, y=VALUE, group=Country.of.residence, 
               fill=Country.of.residence),stat="identity",width=1,alpha=0.8)+
  theme(legend.position = c(0.1,0.7), legend.justification = c(0,0.5))+
  labs(x=NULL,y="Daily travellers entering Canada by air")+
  scale_fill_manual(values=c("brown2","blue3"),breaks = residences, 
                    labels=c("Canadian residents","Non-residents"))+
  scaleDate+
  pubTheme+
  guides(fill=guide_legend(title="Residence"))
p.3a
ggsave(paste0(fold.out,"daily.travellers.Canadian.nonresidents.png"),height=3,width=4)

## so overall non-resident visitors and Canadian-resident visitors daily travel volume was steadily low in 2021 until July, when the reuqirement for fully vaccinated air travellers eligible to enter Canada to quarantine for 3 days in a hotel and provide a test after 8 days ended. Then in September 2021, fully vaccinated foreing nationals were allowed to enter Canada for non essential reasons, which corresponded to a further increase in travel volume

#to incorporate this trend in global air volume coming into Canada, we need to know how the observed non-resident arrivals in the months of the ban differed from what was expected based on trends in seasonality and average travel in 2021. Follow the same approach as above for India, using data from 2018, 2019, and 2022, to calculate expected travel based on seasonality compared to observed. THEN adjust our expected India volume accordingly.

```

## calculate seasonality in broad travel patterns
```{r}
trav.yr<-trav %>% 
  filter(Country.of.residence %in% residences) %>% #here only include the large categories
  dplyr::group_by(year) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav.yr=sum(VALUE,na.rm=T),
            mean.trav.yr=mean(VALUE,na.rm=T),
            median.trav.yr=median(VALUE,na.rm=T),
            max.trav.yr=max(VALUE,na.rm=T),
            min.trav.yr=min(VALUE,na.rm=T))
head( trav.yr)
write.csv(trav.yr,paste0(fold.out,"travel.all.year.csv"))

trav.yr.res<-trav %>% 
  filter(Country.of.residence %in% residences) %>% #here only include the large categories
  dplyr::group_by(year, Country.of.residence) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav.yr=sum(VALUE,na.rm=T),
            mean.trav.yr=mean(VALUE,na.rm=T),
            median.trav.yr=median(VALUE,na.rm=T),
            max.trav.yr=max(VALUE,na.rm=T),
            min.trav.yr=min(VALUE,na.rm=T))
write.csv(trav.yr.res,paste0(fold.out,"travel.res.all.year.csv"))

trav.mo<-trav %>% 
    filter(Country.of.residence %in% residences) %>% #here only include the large categories
  dplyr::group_by(monthyear) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav=sum(VALUE,na.rm=T),
            mean.trav=mean(VALUE,na.rm=T),
            median.trav=median(VALUE,na.rm=T),
            max.trav=max(VALUE,na.rm=T),
            min.trav=min(VALUE,na.rm=T)) 
# head(trav.mo)

#join together using dates
trav.dates<-trav[,c("year","month","monthyear","date")]
trav.dates<-trav.dates[-which(duplicated(trav.dates$monthyear)),]
trav.mo<-left_join(trav.mo, trav.dates,by="monthyear")
trav.all<-left_join(trav.mo,trav.yr, by="year")
# head(trav.all)

#for each month, calculate % dev relative to mean
trav.all<-trav.all %>% mutate(diff.means=mean.trav - mean.trav.yr,
                                          ratio.means=mean.trav/mean.trav.yr,
                                          perc.dev=diff.means / mean.trav.yr) %>%   as.data.frame()
# head(trav.all)


# PLOT IT UPPP
p.3b<-trav.all %>%
  ggplot()+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill="darkorchid4")+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0.01)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers, all sources", x=NULL)
p.3b
ggsave(paste0(fold.out,"Mean daily trav_All.png"),width=4,height=3,units="in")

#composite plot
plot_grid(p.3a, p.3b, labels=LETTERS[1:2],nrow=1)
ggsave(paste0(fold.out, "FIGS17_allsources_travelVol.png"),height=3.5,width=8,units="in")
#fit a spline
trav.all %>%
  ggplot()+
  geom_smooth(aes(x=date, y=mean.trav),stat="identity",color="darkorchid4")+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers ", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav _All_line.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-115,115)
trav.all %>%
  ggplot()+
  geom_bar(aes(x=date, y=diff.means),stat="identity",fill="aquamarine2")+
  scaleDateYr+
  pubTheme+
  scale_y_continuous(expand=expansion(0.01,0))+
  labs(y="Difference between monthly and\nannual mean daily travellers ", x=NULL)
ggsave(paste0(fold.out,"Diff monthly to annual mean daily trav _All.png"),width=4,height=3,units="in")


#plot deviation from mean
y.lim3<-c(0,4)
trav.all %>%
  ggplot()+

  geom_hline(yintercept=1,linetype=12)+
  geom_bar(aes(x=date, y=ratio.means),stat="identity",fill="darkorange")+
  scaleDateYr+
  pubTheme+
  labs(y="Ratio between monthly and\nannual mean daily travellers ", x=NULL)+
  scale_y_continuous(expand=expansion(0.01,0))
ggsave(paste0(fold.out,"Ratio monthly to annual mean daily trav _All.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-100,290)
trav.all %>%
  ggplot()+
  geom_bar(aes(x=date, y=perc.dev*100),stat="identity",fill="blue2")+
  scaleDateYr+
  pubTheme+
  labs(y="Percent deviation between monthly and\nannual mean daily travellers ", x=NULL)+
  scale_y_continuous(expand=expansion(0.01,0))+
  geom_hline(yintercept=0,linetype=12)
ggsave(paste0(fold.out,"Perc dev monthly to annual mean daily trav _All.png"),width=4,height=3,units="in")

# okay so how do we use this information to predict seasonality of covid travel ?
# want to know how many average daily cases were expected in the months of flight ban
# based on the observed seasonality in travel volume 
trav.month.trends<-trav.all %>% 
  filter(!year %in% c("2020","2021")) %>%
  dplyr::group_by(month) %>%
  dplyr::summarise(.groups="rowwise",
                   mean.percdev=mean(perc.dev),
                   mean.diffmeans=mean(diff.means),
                   mean.ratiomeans=mean(ratio.means))

trends.dates<-left_join(trav.dates,trav.month.trends,by="month")
trends.dates<-trends.dates[-which(duplicated(trends.dates$month)),]
trends.dates<-trends.dates[,-which(colnames(trends.dates) %in% c("year","monthyear","date"))]
trends.dates$month<-factor(trends.dates$month,levels=unique(trends.dates$month))
trend.dates.long<-pivot_longer(trends.dates,cols=2:4,names_to="comparison",values_to = "values") %>% as.data.frame()

p.4a<-trend.dates.long %>%
  filter(comparison != "mean.percdev") %>%
  ggplot() +
  geom_bar(aes(y=values,x=month,fill=comparison),stat="identity")+
  facet_wrap(~comparison,scales="free")+
  pubTheme+
  labs(x=NULL,y="Value")+
  theme(legend.position = "none")+
  scale_fill_manual(values=col.comps)
p.4a
ggsave(paste0(fold.out,"Monthly trends in mean deviation.png"),width=7,height=2,units="in")


trav.all2<-left_join(trav.all, trav.month.trends, by="month")
#apply the perc deviaiton to multiply by the mean
trav.all2<-trav.all2 %>% mutate(expected.percdev=(mean.percdev * mean.trav.yr)+mean.trav.yr,
                                            expected.diffmeans=mean.trav.yr + mean.diffmeans,
                                            expected.ratiomeans=mean.trav.yr * mean.ratiomeans)

#resstructre the data frame to be long and only loook at monthly mean travellers
trav.all3<-trav.all2[,match(c("date",  "expected.percdev", "expected.diffmeans",
                                          "expected.ratiomeans", "mean.trav"),colnames(trav.all2))]
trav.all3.long<-trav.all3 %>% pivot_longer(cols=2:5,names_to="calc",values_to="value")

#okayyy now have a looky across all metrics and entire time frame
cols.calc2<-cols.calc
cols.calc2[3]<-"darkorchid4"
y.lim3<-c(0,230)
trav.all3.long %>%
  filter(calc != "expected.percdev") %>%
  ggplot()+ 
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers, all sources", x=NULL)+
  scale_fill_manual(values=cols.calc2)
ggsave(paste0(fold.out,"Expected vs observed Mean daily trav _all.png"),
       width=7,height=3,units="in")

#zoom in on 2021 only
# y.lim3<-c(0,80)
p.4b<-trav.all3.long %>%
    filter(calc != "expected.percdev") %>%
  filter(date>as.Date("2021-01-01") & date<as.Date("2021-12-31")) %>%
  ggplot()+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDate+
  pubTheme+
  theme(legend.position = "top")+
  labs(y="Mean daily travellers, all sources", x=NULL)+
  guides(fill= guide_legend(nrow=1, title="Calculation"))+
    scale_fill_manual(values=cols.calc2)
p.4b
ggsave(paste0(fold.out,"Expected vs observed Mean daily trav_2021.png"),
       width=4,height=3,units="in")

### Okay so need ot calcaulte the difference and ratio between expected daily travellers (resident and non-res, all sources) based on seasonal trends, and the observed daily travellers in 2021 - then use these to correct our expectations of travel in the absence of flight bans

#use the expected.ratiomeans /mean.trav to calculate a adjust.factor
#use expected.diffmeans - mean.trav to calculate a adjust.diff
trav.all4<-trav.all3 %>% mutate(adjust.diff=expected.diffmeans - mean.trav,
                                adjust.factor=expected.ratiomeans / mean.trav)

#adjust = E/O, so E=adjust*O and O=E/adjust
#for India: O is the second expected, E2 (what would have been observed)
#
# head(trav.all4) 
  
# plot the new adjustmenfactors
trav.all4.long <- trav.all4 %>% pivot_longer(cols=2:7,names_to="calc",values_to="value")
p.4c<-trav.all4.long %>%
  filter(date>as.Date("2021-01-01") & date<as.Date("2021-12-31")) %>%
  filter(calc=="adjust.factor") %>%
  ggplot()+
  geom_bar(aes(x=date, y=value),stat="identity",position="dodge", fill="darkcyan")+
  scale_y_continuous(expand=expansion(c(0.01,0.01)))+
  scaleDate+
  pubTheme+
  labs(y="Adjustment factor (Exp./Obs.) ", x=NULL)
p.4c
ggsave(paste0(fold.out,"Adjustment factors for mean daily trav_2021.png"),
       width=4,height=3,units="in")

#COMPOSITE
p.4row<-plot_grid(p.4b,p.4c,labels=LETTERS[2:3],nrow=1,rel_widths = c(1,0.8))
plot_grid(p.4a,p.4row,labels=c("A",""),nrow=2,rel_heights = c(1,1.4))
ggsave(paste0(fold.out,"FIGS18_AllSources_ExpectedVsObserved_AF.png"),height=5,width=8.5,units="in")
```


# Look at India, Delta
## Read in data and plot observed travel
```{r}
## intervention:
int.yn<-TRUE
if(int.yn==T){
  int.start<-as.Date("2021-04-22")
  int.end<-as.Date("2021-09-26")
  int.duration<-int.end-int.start
  int.descrip<-"India flight ban"
}
regcol<-"#41ab5d" 

trav.india<-trav %>%
  filter(Country.of.residence == "India")
# table(trav.india$Traveller.type)

#TRAVEL VOL FROM INDIA around the Delta flight ban
y.lim<-c(min(trav.india$VALUE),max(trav.india$VALUE))

p.1a<-trav.india %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from India",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0.01)))+
  pubTheme+
  scaleDateYr
p.1a
ggsave(paste0(fold.out,"Daily trav from India_2018to2023.png"),width=4,height=3,units="in")

#TRAVEL VOL FROM INDIA around the Delta flight ban
y.lim2<-c(0,610)
p.1b<-trav.india %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=-0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from India",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
p.1b  
ggsave(paste0(fold.out,"Daily trav from India_FebtoDec2021.png"),width=4,height=3,units="in")

#how much seasonality in travel from india histroically?
#if we take a mean across the entire year, how much higher is travel in each month?
trav.india.yr<-trav.india %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav.yr=sum(VALUE,na.rm=T),
            mean.trav.yr=mean(VALUE,na.rm=T),
            median.trav.yr=median(VALUE,na.rm=T),
            max.trav.yr=max(VALUE,na.rm=T),
            min.trav.yr=min(VALUE,na.rm=T))
# trav.india.yr

trav.india.mo<-trav.india %>% 
  dplyr::group_by(monthyear) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav=sum(VALUE,na.rm=T),
            mean.trav=mean(VALUE,na.rm=T),
            median.trav=median(VALUE,na.rm=T),
            max.trav=max(VALUE,na.rm=T),
            min.trav=min(VALUE,na.rm=T)) 
# head(trav.india.mo)

#join together using dates
trav.india.dates<-trav.india[,c("year","month","monthyear","date")]
trav.india.dates<-trav.india.dates[-which(duplicated(trav.india.dates$monthyear)),]
trav.india.mo<-left_join(trav.india.mo, trav.india.dates,by="monthyear")
trav.india.all<-left_join(trav.india.mo,trav.india.yr, by="year")
# head(trav.india.all)

#for each month, calculate % dev relative to mean
trav.india.all<-trav.india.all %>% mutate(diff.means=mean.trav - mean.trav.yr,
                                          ratio.means=mean.trav/mean.trav.yr,
                                          perc.dev=diff.means / mean.trav.yr) %>%   as.data.frame()
# head(trav.india.all)


# PLOT IT UPPP
y.lim3<-c(0,1050)
trav.india.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from India", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from India_All.png"),width=4,height=3,units="in")

#highlight thsese months in each year
p.1c<-trav.india.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  #TEXT
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from India", x=NULL)
p.1c
ggsave(paste0(fold.out,"extra highlights Mean daily trav from India_All.png"),width=4,height=3,units="in")

#make a composite plot
plot_grid(p.1a,p.1b,p.1c, labels=LETTERS[1:3],nrow=1)
ggsave(paste0(fold.out, "FigS14_IndiaObservedTravel.png"),height=3,width=8.5,units="in")

#fit a spline
trav.india.all %>%
  ggplot()+
  geom_smooth(aes(x=date, y=mean.trav),stat="identity",color=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from India", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from India_All_line.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-400,500)
p.2a<-trav.india.all %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=diff.means),stat="identity",fill="aquamarine3")+
  scaleDateYr+
  pubTheme+
  scale_y_continuous(expand=expansion(0,0))+
  labs(y="Difference of monthly and annual\nmean daily travellers from India", x=NULL)
p.2a
ggsave(paste0(fold.out,"Diff monthly to annual mean daily trav from India_All.png"),width=4,height=3,units="in")


#plot deviation from mean
y.lim3<-c(0,4)
p.2b<-trav.india.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_hline(yintercept=1,linetype=12)+
  geom_bar(aes(x=date, y=ratio.means),stat="identity",fill="darkorange3")+
  scaleDateYr+
  pubTheme+
  labs(y="Ratio of monthly and annual\nmean daily travellers from India", x=NULL)+
  scale_y_continuous(expand=expansion(0.01,0))
p.2b
ggsave(paste0(fold.out,"Ratio monthly to annual mean daily trav from India_All.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-100,290)
trav.india.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=perc.dev*100),stat="identity",fill=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Percent deviation between monthly and\nannual mean daily travellers from India", x=NULL)+
  scale_y_continuous(expand=expansion(0,0))+
  geom_hline(yintercept=0,linetype=12)
ggsave(paste0(fold.out,"Perc dev monthly to annual mean daily trav from India_All.png"),width=4,height=3,units="in")
```

## estimate travel expected without ban
```{r}
# okay so how do we use this information to predict seasonality of covid travel from india?
# want to know how many average daily cases were expected in the months of flight ban
# based on the observed seasonality in travel volume from India
trav.india.month.trends<-trav.india.all %>% 
  filter(!year %in% c("2020","2021")) %>%
  dplyr::group_by(month) %>%
  dplyr::summarise(.groups="rowwise",
                   mean.percdev=mean(perc.dev),
                   mean.diffmeans=mean(diff.means),
                   mean.ratiomeans=mean(ratio.means))

trends.dates<-left_join(trav.india.dates,trav.india.month.trends,by="month")
trends.dates<-trends.dates[-which(duplicated(trends.dates$month)),]
trends.dates<-trends.dates[,-which(colnames(trends.dates) %in% c("year","monthyear","date"))]
trends.dates$month<-factor(trends.dates$month,levels=unique(trends.dates$month))
trend.dates.long<-pivot_longer(trends.dates,cols=2:4,names_to="comparison",values_to = "values") %>% as.data.frame()

col.comps<-c("aquamarine3","darkorange3")
names(col.comps)<-c("mean.diffmeans","mean.ratiomeans")

p.2c<-trend.dates.long %>%
  filter(comparison !="mean.percdev") %>%
  ggplot() +
  geom_bar(aes(y=values,x=month,fill=comparison),stat="identity")+
  facet_wrap(~comparison,scales="free")+
  pubTheme+
  labs(x=NULL,y="Value")+
  scale_fill_manual(values=col.comps)+
  theme(legend.position="none")
p.2c
ggsave(paste0(fold.out,"Monthly trends in mean deviation_india.png"),width=7,height=2,units="in")

## composite plot
p.2row<-plot_grid(p.2a,p.2b,labels=LETTERS[1:2], nrow=1)
plot_grid(p.2row, p.2c, labels=c("","C"),nrow=2,rel_heights = c(1.2,0.8))
ggsave(paste0(fold.out,"FIGS15_India-diff-monthly-annual-mean.png"),height=5,width=8.5,units="in")

trav.india.all2<-left_join(trav.india.all, trav.india.month.trends, by="month")
#apply the perc deviaiton to multiply by the mean
trav.india.all2<-trav.india.all2 %>% mutate(
  expected.percdev=(mean.percdev * mean.trav.yr)+mean.trav.yr,
  expected.diffmeans=mean.trav.yr + mean.diffmeans,
  expected.ratiomeans=mean.trav.yr * mean.ratiomeans)

#resstructre the data frame to be long and only loook at monthly mean travellers
trav.india.all3<-trav.india.all2[,match(c("date",  "expected.percdev", "expected.diffmeans",
                                          "expected.ratiomeans", "mean.trav"),colnames(trav.india.all2))]
trav.india.all3.long<-trav.india.all3 %>% pivot_longer(cols=2:5,names_to="calc",values_to="value")

#okayyy now have a looky across all metrics and entire time frame
cols.calc<-c(col.comps,regcol)
names(cols.calc)<-c("expected.diffmeans","expected.ratiomeans","mean.trav")
y.lim3<-c(0,1000)
trav.india.all3.long %>%
  filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+

  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from India", x=NULL)+
  scale_fill_manual(values=cols.calc)
ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from India_all.png"),
       width=7,height=3,units="in")

#zoom in on 2021 only
y.lim3<-c(-1,500)
trav.india.all3.long %>%
  filter(date>as.Date("2021-01-01") & date<as.Date("2021-12-31")) %>%
    filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=-0.8,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDate+
  pubTheme+
  theme(legend.position = "top")+
  labs(y="Mean daily travellers from India", x=NULL)+
  guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc)

ggsave(paste0(fold.out,"FIGS16_Expected vs observed Mean daily trav from India_2021.png"),
       width=5,height=3,units="in")

```

## Apply global travel adjustment factor to travel expectations
```{r}
#join the adjust.factors on to the expected India travel data
head(trav.india.all3)
colnames(trav.india.all3)[5]<-"Observed (ban)"
colnames(trav.india.all3)[4]<-"Expected 1 (no ban)"

trav.all4.red<-trav.all4[,which(colnames(trav.all4) %in% c("date","adjust.factor"))]

trav.india.all4<-left_join(trav.india.all3, trav.all4.red, by="date")
head(trav.india.all4)

#apply the adjustment factor
trav.india.all4<- trav.india.all4 %>% 
  mutate(expected2 = `Expected 1 (no ban)`/adjust.factor)

#plot the two expected together
colnames(trav.india.all4)[7]<-"Expected, adjusted (no ban)"  
trav.india.all4.long<-trav.india.all4 %>% 
  pivot_longer(cols=2:7,names_to="calc",values_to="value")

cols.calc3<-c("darkorange3","darkcyan",regcol)
names(cols.calc3)<-c("Expected 1 (no ban)", "Expected, adjusted (no ban)", "Observed (ban)")
y.lim<-c(0,410)
trav.india.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected 1 (no ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2021-01-01") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=-.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from India", x=NULL)+
    guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc3)

ggsave(paste0(fold.out,"FIGS19_Adjusted expectation mean daily India trav_2021.png"),
         width=5,height=3,units="in")

cols.calc4<-cols.calc3[c(2,3)]
trav.india.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2021-01-01") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=-.7,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from India", x=NULL)+
    guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc4)

ggsave(paste0(fold.out,"Adjusted expectation only mean daily India trav_2021.png"),
         width=4,height=3,units="in")

```

## convert monthly to rolling daily expected travel 
```{r}
#first, check the daily observed travel from india
trav.india.daily<-trav.india[,which(colnames(trav.india) %in% 
                                      c("REF_DATE","VALUE",
                                        "year","monthyear","month","date"))]

colnames(trav.india.daily)[2]<-"Observed"

#now, leftjoin the monthyl expected data by "date" (actually month with 01)
trav.india.all.red<-trav.india.all4 %>% select (c("date","Expected, adjusted (no ban)",
                                                  "Observed (ban)"))
trav.india.oe<-left_join(trav.india.daily,trav.india.all.red,by="date")

#rearrange and clean
trav.india.oe<-trav.india.oe[,c(1,3,4,5,2,7,8)]
head(trav.india.oe)
colnames(trav.india.oe)[c(6,7)]<-c("MonthlyAve_exp","MonthlyAve_obs")


## add a spline fit with daily predictions to this

pred.val.df<-trav.india.oe
pred.val.df$decdate<-decimal_date(pred.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
pred.val.df$MonthlyAve_exp[str_which(pred.val.df$REF_DATE, "15",negate = T)]<-NA
pred.vals<-spline(x=pred.val.df$decdate, y=pred.val.df$MonthlyAve_exp,
                  xout=pred.val.df$decdate)
length(pred.vals$y)==nrow(pred.val.df)

#join these
pred.vals.df2<-pred.vals %>% as.data.frame()
colnames(pred.vals.df2)<-c("decdate","Expected (no ban)")
pred.vals.all<-left_join(pred.val.df,pred.vals.df2,by="decdate")
pred.vals.all.red<-pred.vals.all %>% select(c(`REF_DATE`,`Expected (no ban)`))
#now join back to obs vs expceted
trav.india.oe2<-left_join(trav.india.oe, pred.vals.all.red, by="REF_DATE")

trav.india.oe2.long<-trav.india.oe2 %>% pivot_longer(cols=5:8,names_to = "name",
                                                   values_to="value")
y.lim2<-c(0,300)
p.5a<-trav.india.oe2.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","MonthlyAve_exp"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=-0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,linetype=name),color="darkcyan")+
  labs(y="Daily travellers from India",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  coord_cartesian(ylim=y.lim2)+
  theme(legend.position = c(0.1,0.7),legend.justification = c(0,0.5))+
  guides(linetype=guide_legend(title="Calculation"))
p.5a

ggsave(paste0(fold.out,"Daily vs average expected from India_2021.png"),width=4,height=3,units="in")

y.lim2<-c(0,600)
p.5b<-trav.india.oe2.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=-0.1,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from India",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Calculation"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.1,0.7),legend.justification = c(0,0.5))
p.5b
ggsave(paste0(fold.out,"Daily expected vs observed from India_2021.png"),width=4,height=3,units="in")

#limited x version
p.supp.ind<-trav.india.oe2.long %>%
  filter(REF_DATE >= as.Date("2021-03-01")) %>%
  filter(REF_DATE < as.Date("2021-10-31")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=-0.1,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from India",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Calculation"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.1,0.8),legend.justification = c(0,0.5))

#composite
plot_grid(p.5a,p.5b,labels=LETTERS[1:2],nrow=1)
ggsave(paste0(fold.out,"FIGS20_India_ExpectedvsObserved.png"),height=3,width=8.5,units="in")

#Make a smoother version of the observed data
predobs.val.df<-trav.india.oe
predobs.val.df$decdate<-decimal_date(predobs.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
predobs.val.df$MonthlyAve_obs[str_which(predobs.val.df$REF_DATE, "15",negate = T)]<-NA
predobs.vals<-spline(x=predobs.val.df$decdate, y=predobs.val.df$MonthlyAve_obs,
                  xout=predobs.val.df$decdate)
length(predobs.vals$y)==nrow(predobs.val.df)

#join these
predobs.vals.df2<-predobs.vals %>% as.data.frame()
colnames(predobs.vals.df2)<-c("decdate","Observed, smooth (ban)")
predobs.vals.all<-left_join(predobs.val.df,predobs.vals.df2,by="decdate")
predobs.vals.all.red<-predobs.vals.all %>% select(c(`REF_DATE`,`Observed, smooth (ban)`))
#now join back to obs vs expceted
trav.india.oe3<-left_join(trav.india.oe2, predobs.vals.all.red, by="REF_DATE")

trav.india.oe3.long<-trav.india.oe3 %>% pivot_longer(cols=5:9,names_to = "name",
                                                   values_to="value")

trav.india.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","MonthlyAve_obs","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=-0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from India",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
ggsave(paste0(fold.out,"Daily smooth,daily, vs average observed from India_2021.png"),width=4,height=3,units="in")

#okay now a final plot of observed smooth and expected daily travellers
trav.india.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=450, vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from India",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=c(0,450))+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))


ggsave(paste0(fold.out,"Daily observed smooth vs expected from India_2021.png"),width=4,height=3,units="in")

#RAW OBSEREVED
y.lim2<-c(0,600)
trav.india.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from India",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily observed raw vs expected from India_2021.png"),width=4,height=3,units="in")


#okay now a final plot of observed raw and expected daily travellers
y.lim2<-c(0,600)
trav.india.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-03-01")) %>%
  filter(REF_DATE < as.Date("2021-10-31")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from India",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
  theme(legend.position = c(0.2,0.7),legend.justification = c(0,0.5))


ggsave(paste0(fold.out,"Daily observed raw vs expected from India_2021-restr.png"),width=3,height=3,units="in")


```

## calculate the difference under the curves
```{r}
#area under expected, during ban
#sum the daily average from each day in the ban
total.expected<-trav.india.oe3.long %>%
  filter(name %in% "Expected (no ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.expected #17958

#area under observed (smooth), during ban
total.observed.smooth<-trav.india.oe3.long %>%
  filter(name %in% "Observed, smooth (ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.smooth #13746

#actual sum of observed, during ban
total.observed.actual<-trav.india.oe3.long %>%
  filter(name %in%"Observed" ) %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.actual #12811

#difference
diff.actual<-total.expected - total.observed.actual
diff.smooth<-total.expected - total.observed.smooth
diff.actual; diff.smooth
```

## Delta trav averted over time
```{r}
## CALCULATE THIS DIFF FOR TWO SEPARATE PERIODS
trav.india.oe3.2<-trav.india.oe3 %>% mutate("trav.averted"=`Expected (no ban)` - Observed )

#PLOT THE TRAVELLERS AVERTED OVERTIME
y.lim2<-c(-100,150)
trav.india.oe3.2 %>%
  filter(REF_DATE >= int.start-21 & REF_DATE <= int.end+21) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=trav.averted),color="darkgreen")+
  geom_hline(yintercept = 0,linetype=14,color="grey40")+
  coord_cartesian(ylim=y.lim2)+
  labs(y="Daily travellers averted (exp.-obs.)",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c(regcol))+
  coord_cartesian(ylim=y.lim2)
ggsave(paste0(fold.out,"FIGS22.IndiaTravAvertedOvertime.png"),width=4,height=3,units="in")

#hwat does a rolling mean look like
trav.india.oe3.2<-trav.india.oe3.2 %>% mutate(rolling= zoo::rollmean(trav.averted,k=7,fill = NA),remove=F)

y.lim2<-c(-50,70)
trav.india.oe3.2 %>%
  filter(REF_DATE >= int.start-14 & REF_DATE <= int.end+14) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=rolling),color="darkgreen")+
  geom_hline(yintercept = 0,linetype=14,color="grey40")+
  coord_cartesian(ylim=y.lim2)+
  labs(y="Rolling ave. daily travellers averted (exp.-obs.)",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c(regcol))+
  coord_cartesian(ylim=y.lim2)
ggsave(paste0(fold.out,"Rolling.IndiaTravAvertedOvertime.png"),width=4,height=3,units="in")


#on what day did trav averted decrease below 10
trav.india.oe3.3<-trav.india.oe3.2  %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end)

#on what days <10 averted
trav.india.oe3.3$REF_DATE[which(trav.india.oe3.3$trav.averted<10)]
 # "2021-06-24" "2021-06-26"
trav.india.oe3.3$REF_DATE[which(trav.india.oe3.3$rolling<10)]
 # "2021-07-07" "2021-07-08" "2021-07-09" 

#on what days were >50 travellers averted
trav.india.oe3.3$REF_DATE[which(trav.india.oe3.3$trav.averted>50)]
# "2021-06-21" "2021-06-28" "2021-07-16" 
trav.india.oe3.3$REF_DATE[which(trav.india.oe3.3$rolling>50)]
# "2021-06-18" then not again until August

```

## Export expected travel
```{r}
## Export expected and observed
write.csv(trav.india.oe3, paste0(fold.out2,"trav.india.obs-exp.csv"))
```


# Look at Pakistan, Delta
## Read in data and plot observed travel
```{r}
## intervention:
int.yn<-TRUE
if(int.yn==T){
  int.start<-as.Date("2021-04-22")
  int.end<-as.Date("2021-06-21")
  int.duration<-int.end-int.start
  int.descrip<-"Pakistan flight ban"
}
regcol<-"#41ab5d" 

trav.Pakistan<-trav %>%
  filter(Country.of.residence == "Pakistan")
# table(trav.Pakistan$Traveller.type)

#TRAVEL VOL FROM Pakistan around the Delta flight ban
y.lim<-c(min(trav.Pakistan$VALUE),max(trav.Pakistan$VALUE))

p.1a<-trav.Pakistan %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from Pakistan",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0.01)))+
  pubTheme+
  scaleDateYr
p.1a
ggsave(paste0(fold.out,"Daily trav from Pakistan_2018to2023.png"),width=4,height=3,units="in")

#TRAVEL VOL FROM Pakistan around the Delta flight ban
y.lim2<-c(0,70)
p.1b<-trav.Pakistan %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=-0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from Pakistan",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
p.1b  
ggsave(paste0(fold.out,"Daily trav from Pakistan_FebtoDec2021.png"),width=4,height=3,units="in")

#how much seasonality in travel from Pakistan histroically?
#if we take a mean across the entire year, how much higher is travel in each month?
trav.Pakistan.yr<-trav.Pakistan %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav.yr=sum(VALUE,na.rm=T),
            mean.trav.yr=mean(VALUE,na.rm=T),
            median.trav.yr=median(VALUE,na.rm=T),
            max.trav.yr=max(VALUE,na.rm=T),
            min.trav.yr=min(VALUE,na.rm=T))
# trav.Pakistan.yr

trav.Pakistan.mo<-trav.Pakistan %>% 
  dplyr::group_by(monthyear) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav=sum(VALUE,na.rm=T),
            mean.trav=mean(VALUE,na.rm=T),
            median.trav=median(VALUE,na.rm=T),
            max.trav=max(VALUE,na.rm=T),
            min.trav=min(VALUE,na.rm=T)) 
# head(trav.Pakistan.mo)

#join together using dates
trav.Pakistan.dates<-trav.Pakistan[,c("year","month","monthyear","date")]
trav.Pakistan.dates<-trav.Pakistan.dates[-which(duplicated(trav.Pakistan.dates$monthyear)),]
trav.Pakistan.mo<-left_join(trav.Pakistan.mo, trav.Pakistan.dates,by="monthyear")
trav.Pakistan.all<-left_join(trav.Pakistan.mo,trav.Pakistan.yr, by="year")
# head(trav.Pakistan.all)

#for each month, calculate % dev relative to mean
trav.Pakistan.all<-trav.Pakistan.all %>% mutate(diff.means=mean.trav - mean.trav.yr,
                                          ratio.means=mean.trav/mean.trav.yr,
                                          perc.dev=diff.means / mean.trav.yr) %>%   as.data.frame()
# head(trav.Pakistan.all)


# PLOT IT UPPP
y.lim3<-c(0,80)
trav.Pakistan.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Pakistan", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from Pakistan_All.png"),width=4,height=3,units="in")

#highlight thsese months in each year
p.1c<-trav.Pakistan.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  #TEXT
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Pakistan", x=NULL)
p.1c
ggsave(paste0(fold.out,"extra highlights Mean daily trav from Pakistan_All.png"),width=4,height=3,units="in")

#make a composite plot
plot_grid(p.1a,p.1b,p.1c, labels=LETTERS[1:3],nrow=1)
ggsave(paste0(fold.out, "FigS14_PakistanObservedTravel.png"),height=3,width=8.5,units="in")

#fit a spline
trav.Pakistan.all %>%
  ggplot()+
  geom_smooth(aes(x=date, y=mean.trav),stat="identity",color=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Pakistan", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from Pakistan_All_line.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-20,50)
p.2a<-trav.Pakistan.all %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=diff.means),stat="identity",fill="aquamarine3")+
  scaleDateYr+
  pubTheme+
  scale_y_continuous(expand=expansion(0,0))+
  labs(y="Difference of monthly and annual\nmean daily travellers from Pakistan", x=NULL)
p.2a
ggsave(paste0(fold.out,"Diff monthly to annual mean daily trav from Pakistan_All.png"),width=4,height=3,units="in")


#plot deviation from mean
y.lim3<-c(0,4)
p.2b<-trav.Pakistan.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_hline(yintercept=1,linetype=12)+
  geom_bar(aes(x=date, y=ratio.means),stat="identity",fill="darkorange3")+
  scaleDateYr+
  pubTheme+
  labs(y="Ratio of monthly and annual\nmean daily travellers from Pakistan", x=NULL)+
  scale_y_continuous(expand=expansion(0.01,0))
p.2b
ggsave(paste0(fold.out,"Ratio monthly to annual mean daily trav from Pakistan_All.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-100,160)
trav.Pakistan.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=perc.dev*100),stat="identity",fill=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Percent deviation between monthly and\nannual mean daily travellers from Pakistan", x=NULL)+
  scale_y_continuous(expand=expansion(0,0))+
  geom_hline(yintercept=0,linetype=12)
ggsave(paste0(fold.out,"Perc dev monthly to annual mean daily trav from Pakistan_All.png"),width=4,height=3,units="in")
```

## estimate travel expected without ban
```{r}
# okay so how do we use this information to predict seasonality of covid travel from Pakistan?
# want to know how many average daily cases were expected in the months of flight ban
# based on the observed seasonality in travel volume from Pakistan
trav.Pakistan.month.trends<-trav.Pakistan.all %>% 
  filter(!year %in% c("2020","2021")) %>%
  dplyr::group_by(month) %>%
  dplyr::summarise(.groups="rowwise",
                   mean.percdev=mean(perc.dev),
                   mean.diffmeans=mean(diff.means),
                   mean.ratiomeans=mean(ratio.means))

trends.dates<-left_join(trav.Pakistan.dates,trav.Pakistan.month.trends,by="month")
trends.dates<-trends.dates[-which(duplicated(trends.dates$month)),]
trends.dates<-trends.dates[,-which(colnames(trends.dates) %in% c("year","monthyear","date"))]
trends.dates$month<-factor(trends.dates$month,levels=unique(trends.dates$month))
trend.dates.long<-pivot_longer(trends.dates,cols=2:4,names_to="comparison",values_to = "values") %>% as.data.frame()

col.comps<-c("aquamarine3","darkorange3")
names(col.comps)<-c("mean.diffmeans","mean.ratiomeans")

p.2c<-trend.dates.long %>%
  filter(comparison !="mean.percdev") %>%
  ggplot() +
  geom_bar(aes(y=values,x=month,fill=comparison),stat="identity")+
  facet_wrap(~comparison,scales="free")+
  pubTheme+
  labs(x=NULL,y="Value")+
  scale_fill_manual(values=col.comps)+
  theme(legend.position="none")
p.2c
ggsave(paste0(fold.out,"Monthly trends in mean deviation_Pakistan.png"),width=7,height=2,units="in")

## composite plot
p.2row<-plot_grid(p.2a,p.2b,labels=LETTERS[1:2], nrow=1)
plot_grid(p.2row, p.2c, labels=c("","C"),nrow=2,rel_heights = c(1.2,0.8))
ggsave(paste0(fold.out,"FIGS15_Pakistan-diff-monthly-annual-mean.png"),height=5,width=8.5,units="in")

trav.Pakistan.all2<-left_join(trav.Pakistan.all, trav.Pakistan.month.trends, by="month")
#apply the perc deviaiton to multiply by the mean
trav.Pakistan.all2<-trav.Pakistan.all2 %>% mutate(
  expected.percdev=(mean.percdev * mean.trav.yr)+mean.trav.yr,
  expected.diffmeans=mean.trav.yr + mean.diffmeans,
  expected.ratiomeans=mean.trav.yr * mean.ratiomeans)

#resstructre the data frame to be long and only loook at monthly mean travellers
trav.Pakistan.all3<-trav.Pakistan.all2[,match(c("date",  "expected.percdev", "expected.diffmeans",
                                          "expected.ratiomeans", "mean.trav"),colnames(trav.Pakistan.all2))]
trav.Pakistan.all3.long<-trav.Pakistan.all3 %>% pivot_longer(cols=2:5,names_to="calc",values_to="value")

#okayyy now have a looky across all metrics and entire time frame
cols.calc<-c(col.comps,regcol)
names(cols.calc)<-c("expected.diffmeans","expected.ratiomeans","mean.trav")
y.lim3<-c(0,100)
trav.Pakistan.all3.long %>%
  filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+

  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Pakistan", x=NULL)+
  scale_fill_manual(values=cols.calc)
ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from Pakistan_all.png"),
       width=7,height=3,units="in")

#zoom in on 2021 only
y.lim3<-c(-1,60)
trav.Pakistan.all3.long %>%
  filter(date>as.Date("2021-01-01") & date<as.Date("2021-12-31")) %>%
    filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=-0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDate+
  pubTheme+
  theme(legend.position = "top")+
  labs(y="Mean daily travellers from Pakistan", x=NULL)+
  guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc)

ggsave(paste0(fold.out,"FIGS16_Expected vs observed Mean daily trav from Pakistan_2021.png"),
       width=5,height=3,units="in")

```

## Apply global travel adjustment factor to travel expectations
```{r}
#join the adjust.factors on to the expected Pakistan travel data
# head(trav.Pakistan.all3)
colnames(trav.Pakistan.all3)[5]<-"Observed (ban)"
colnames(trav.Pakistan.all3)[4]<-"Expected 1 (no ban)"

trav.all4.red<-trav.all4[,which(colnames(trav.all4) %in% c("date","adjust.factor"))]

trav.Pakistan.all4<-left_join(trav.Pakistan.all3, trav.all4.red, by="date")
# head(trav.Pakistan.all4)

#apply the adjustment factor
trav.Pakistan.all4<- trav.Pakistan.all4 %>% 
  mutate(expected2 = `Expected 1 (no ban)`/adjust.factor)

#plot the two expected together
colnames(trav.Pakistan.all4)[7]<-"Expected, adjusted (no ban)"  
trav.Pakistan.all4.long<-trav.Pakistan.all4 %>% 
  pivot_longer(cols=2:7,names_to="calc",values_to="value")

cols.calc3<-c("darkorange3","darkcyan",regcol)
names(cols.calc3)<-c("Expected 1 (no ban)", "Expected, adjusted (no ban)", "Observed (ban)")
y.lim<-c(0,30)
trav.Pakistan.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected 1 (no ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2021-01-01") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=-.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from Pakistan", x=NULL)+
    guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc3)

ggsave(paste0(fold.out,"FIGS19B_Adjusted expectation mean daily Pakistan trav_2021.png"),
         width=5,height=3,units="in")

cols.calc4<-cols.calc3[c(2,3)]
trav.Pakistan.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2021-01-01") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=-0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from Pakistan", x=NULL)+
    guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc4)

ggsave(paste0(fold.out,"Adjusted expectation only mean daily Pakistan trav_2021.png"),
         width=4,height=3,units="in")

```

## convert monthly to rolling daily expected travel 
```{r}
#first, check the daily observed travel from Pakistan
trav.Pakistan.daily<-trav.Pakistan[,which(colnames(trav.Pakistan) %in% 
                                      c("REF_DATE","VALUE",
                                        "year","monthyear","month","date"))]

colnames(trav.Pakistan.daily)[2]<-"Observed"

#now, leftjoin the monthyl expected data by "date" (actually month with 01)
trav.Pakistan.all.red<-trav.Pakistan.all4 %>% select (c("date","Expected, adjusted (no ban)",
                                                  "Observed (ban)"))
trav.Pakistan.oe<-left_join(trav.Pakistan.daily,trav.Pakistan.all.red,by="date")

#rearrange and clean
trav.Pakistan.oe<-trav.Pakistan.oe[,c(1,3,4,5,2,7,8)]
head(trav.Pakistan.oe)
colnames(trav.Pakistan.oe)[c(6,7)]<-c("MonthlyAve_exp","MonthlyAve_obs")


## add a spline fit with daily predictions to this

pred.val.df<-trav.Pakistan.oe
pred.val.df$decdate<-decimal_date(pred.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
pred.val.df$MonthlyAve_exp[str_which(pred.val.df$REF_DATE, "15",negate = T)]<-NA
pred.vals<-spline(x=pred.val.df$decdate, y=pred.val.df$MonthlyAve_exp,
                  xout=pred.val.df$decdate)
length(pred.vals$y)==nrow(pred.val.df)

#join these
pred.vals.df2<-pred.vals %>% as.data.frame()
colnames(pred.vals.df2)<-c("decdate","Expected (no ban)")
pred.vals.all<-left_join(pred.val.df,pred.vals.df2,by="decdate")
pred.vals.all.red<-pred.vals.all %>% select(c(`REF_DATE`,`Expected (no ban)`))
#now join back to obs vs expceted
trav.Pakistan.oe2<-left_join(trav.Pakistan.oe, pred.vals.all.red, by="REF_DATE")

trav.Pakistan.oe2.long<-trav.Pakistan.oe2 %>% pivot_longer(cols=5:8,names_to = "name",
                                                   values_to="value")
y.lim2<-c(0,40)
p.5a<-trav.Pakistan.oe2.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","MonthlyAve_exp"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=-0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,linetype=name),color="darkcyan")+
  labs(y="Daily travellers from Pakistan",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  coord_cartesian(ylim=y.lim2)+
  theme(legend.position = c(0.1,0.7),legend.justification = c(0,0.5))+
  guides(linetype=guide_legend(title="Calculation"))
p.5a

ggsave(paste0(fold.out,"Daily vs average expected from Pakistan_2021.png"),width=4,height=3,units="in")

y.lim2<-c(0,70)
p.5b<-trav.Pakistan.oe2.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=-0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Pakistan",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Calculation"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.1,0.7),legend.justification = c(0,0.5))
p.5b
ggsave(paste0(fold.out,"Daily expected vs observed from Pakistan_2021.png"),width=4,height=3,units="in")

#limited x version
p.supp.ind<-trav.Pakistan.oe2.long %>%
  filter(REF_DATE >= as.Date("2021-03-01")) %>%
  filter(REF_DATE < as.Date("2021-10-31")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=-0.1,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Pakistan",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Calculation"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.1,0.8),legend.justification = c(0,0.5))

#composite
plot_grid(p.5a,p.5b,labels=LETTERS[1:2],nrow=1)
ggsave(paste0(fold.out,"FIGS20_Pakistan_ExpectedvsObserved.png"),height=3,width=8.5,units="in")

#Make a smoother version of the observed data
predobs.val.df<-trav.Pakistan.oe
predobs.val.df$decdate<-decimal_date(predobs.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
predobs.val.df$MonthlyAve_obs[str_which(predobs.val.df$REF_DATE, "15",negate = T)]<-NA
predobs.vals<-spline(x=predobs.val.df$decdate, y=predobs.val.df$MonthlyAve_obs,
                  xout=predobs.val.df$decdate)
length(predobs.vals$y)==nrow(predobs.val.df)

#join these
predobs.vals.df2<-predobs.vals %>% as.data.frame()
colnames(predobs.vals.df2)<-c("decdate","Observed, smooth (ban)")
predobs.vals.all<-left_join(predobs.val.df,predobs.vals.df2,by="decdate")
predobs.vals.all.red<-predobs.vals.all %>% select(c(`REF_DATE`,`Observed, smooth (ban)`))
#now join back to obs vs expceted
trav.Pakistan.oe3<-left_join(trav.Pakistan.oe2, predobs.vals.all.red, by="REF_DATE")

trav.Pakistan.oe3.long<-trav.Pakistan.oe3 %>% pivot_longer(cols=5:9,names_to = "name",
                                                   values_to="value")

trav.Pakistan.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","MonthlyAve_obs","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=-0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Pakistan",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
ggsave(paste0(fold.out,"Daily smooth,daily, vs average observed from Pakistan_2021.png"),width=4,height=3,units="in")

#okay now a final plot of observed smooth and expected daily travellers
trav.Pakistan.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=450, vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Pakistan",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))


ggsave(paste0(fold.out,"Daily observed smooth vs expected from Pakistan_2021.png"),width=4,height=3,units="in")

#RAW OBSEREVED
# y.lim2<-c(0,600)
trav.Pakistan.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-01-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Pakistan",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily observed raw vs expected from Pakistan_2021.png"),width=4,height=3,units="in")


#okay now a final plot of observed raw and expected daily travellers
# y.lim2<-c(0,600)
trav.Pakistan.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-03-01")) %>%
  filter(REF_DATE < as.Date("2021-10-31")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)-10,y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Pakistan",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
  theme(legend.position = c(0.01,0.8),legend.justification = c(0,0.5))

ggsave(paste0(fold.out,"Daily observed raw vs expected from Pakistan_2021-restr.png"),width=3,height=3,units="in")

```

## calculate the difference under the curves
```{r}
#area under expected, during ban
#sum the daily average from each day in the ban
total.expected<-trav.Pakistan.oe3.long %>%
  filter(name %in% "Expected (no ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.expected #193

#area under observed (smooth), during ban
total.observed.smooth<-trav.Pakistan.oe3.long %>%
  filter(name %in% "Observed, smooth (ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.smooth #126

#actual sum of observed, during ban
total.observed.actual<-trav.Pakistan.oe3.long %>%
  filter(name %in%"Observed" ) %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.actual #77

#difference
diff.actual<-total.expected - total.observed.actual
diff.smooth<-total.expected - total.observed.smooth
diff.actual; diff.smooth #116, 67
```

## Delta trav averted over time
```{r}
## CALCULATE THIS DIFF FOR TWO SEPARATE PERIODS
trav.Pakistan.oe3.2<-trav.Pakistan.oe3 %>% mutate("trav.averted"=`Expected (no ban)` - Observed )

#PLOT THE TRAVELLERS AVERTED OVERTIME
y.lim2<-c(-100,150)
trav.Pakistan.oe3.2 %>%
  filter(REF_DATE >= int.start-21 & REF_DATE <= int.end+21) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=trav.averted),color="darkgreen")+
  geom_hline(yintercept = 0,linetype=14,color="grey40")+
  coord_cartesian(ylim=y.lim2)+
  labs(y="Daily travellers averted (exp.-obs.)",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c(regcol))+
  coord_cartesian(ylim=y.lim2)
ggsave(paste0(fold.out,"FIGS22.PakistanTravAvertedOvertime.png"),width=4,height=3,units="in")

#hwat does a rolling mean look like
trav.Pakistan.oe3.2<-trav.Pakistan.oe3.2 %>% mutate(rolling= zoo::rollmean(trav.averted,k=7,fill = NA),remove=F)

y.lim2<-c(-50,70)
trav.Pakistan.oe3.2 %>%
  filter(REF_DATE >= int.start-14 & REF_DATE <= int.end+14) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+30,y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=rolling),color="darkgreen")+
  geom_hline(yintercept = 0,linetype=14,color="grey40")+
  coord_cartesian(ylim=y.lim2)+
  labs(y="Rolling ave. daily travellers averted (exp.-obs.)",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c(regcol))+
  coord_cartesian(ylim=y.lim2)
ggsave(paste0(fold.out,"Rolling.PakistanTravAvertedOvertime.png"),width=4,height=3,units="in")


#on what day did trav averted decrease below 10
trav.Pakistan.oe3.3<-trav.Pakistan.oe3.2  %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end)

#on what days <10 averted
trav.Pakistan.oe3.3$REF_DATE[which(trav.Pakistan.oe3.3$trav.averted<10)]
 # "2021-06-24" "2021-06-26"
trav.Pakistan.oe3.3$REF_DATE[which(trav.Pakistan.oe3.3$rolling<10)]
 # "2021-07-07" "2021-07-08" "2021-07-09" 

#on what days were >50 travellers averted
trav.Pakistan.oe3.3$REF_DATE[which(trav.Pakistan.oe3.3$trav.averted>50)]
# "2021-06-21" "2021-06-28" "2021-07-16" 
trav.Pakistan.oe3.3$REF_DATE[which(trav.Pakistan.oe3.3$rolling>50)]
# "2021-06-18" then not again until August

```

## Export expected travel
```{r}
## Export expected and observed
write.csv(trav.Pakistan.oe3, paste0(fold.out2,"trav.Pakistan.obs-exp.csv"))
```



# Repeat for UK
## Read in data and plot observed travel
```{r}
## intervention:
int.yn<-TRUE
if(int.yn==T){
  int.start<-as.Date("2020-12-20")
  int.end<-as.Date("2021-01-06")
  int.duration<-int.end-int.start
  int.descrip<-"UK flight ban"
}

#observed color for UK
regcol<-"#225ea8"

trav.uk<-trav %>%
  filter(Country.of.residence == "United Kingdom")
# table(trav.uk$Traveller.type)

#TRAVEL VOL FROM UK around the Alpha flight ban
y.lim<-c(min(trav.uk$VALUE),max(trav.uk$VALUE))

trav.uk %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from UK",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0.01)))+
  pubTheme+
  scaleDateYr
ggsave(paste0(fold.out,"Daily trav from UK_2018to2023.png"),width=4,height=3,units="in")

#TRAVEL VOL FROM UK around the Alpha flight ban
y.lim2<-c(0,2050)
trav.uk %>%
  filter(REF_DATE >= as.Date("2020-12-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from UK",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
  
ggsave(paste0(fold.out,"Daily trav from UK_FebtoDec2021.png"),width=4,height=3,units="in")

#how much seasonality in travel from uk histroically?
#if we take a mean across the entire year, how much higher is travel in each month?
trav.uk.yr<-trav.uk %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav.yr=sum(VALUE,na.rm=T),
            mean.trav.yr=mean(VALUE,na.rm=T),
            median.trav.yr=median(VALUE,na.rm=T),
            max.trav.yr=max(VALUE,na.rm=T),
            min.trav.yr=min(VALUE,na.rm=T))
# trav.uk.yr

trav.uk.mo<-trav.uk %>% 
  dplyr::group_by(monthyear) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav=sum(VALUE,na.rm=T),
            mean.trav=mean(VALUE,na.rm=T),
            median.trav=median(VALUE,na.rm=T),
            max.trav=max(VALUE,na.rm=T),
            min.trav=min(VALUE,na.rm=T)) 
# head(trav.uk.mo)

#join together using dates
trav.uk.dates<-trav.uk[,c("year","month","monthyear","date")]
trav.uk.dates<-trav.uk.dates[-which(duplicated(trav.uk.dates$monthyear)),]
trav.uk.mo<-left_join(trav.uk.mo, trav.uk.dates,by="monthyear")
trav.uk.all<-left_join(trav.uk.mo,trav.uk.yr, by="year")
# head(trav.uk.all)

#for each month, calculate % dev relative to mean
trav.uk.all<-trav.uk.all %>% mutate(diff.means=mean.trav - mean.trav.yr,
                                          ratio.means=mean.trav/mean.trav.yr,
                                          perc.dev=diff.means / mean.trav.yr) %>%   as.data.frame()
# head(trav.uk.all)


# PLOT IT UPPP
y.lim3<-c(0,3000)
trav.uk.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from UK", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from UK_All.png"),width=4,height=3,units="in")

#highlight thsese months in each year
trav.uk.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from UK", x=NULL)
ggsave(paste0(fold.out,"extra highlights Mean daily trav from UK_All.png"),width=4,height=3,units="in")

#fit a spline
trav.uk.all %>%
  ggplot()+
  geom_smooth(aes(x=date, y=mean.trav),stat="identity",color=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from UK", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from UK_All_line.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-1100,1550)
trav.uk.all %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+2*365), xmax = as.Date(int.end+2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+ 
  geom_bar(aes(x=date, y=diff.means),stat="identity",fill="aquamarine3")+
  scaleDateYr+
  pubTheme+
  scale_y_continuous(expand=expansion(0,0))+
  labs(y="Difference between monthly and annual\nmean daily travellers from UK", x=NULL)
ggsave(paste0(fold.out,"Diff monthly to annual mean daily trav from UK_All.png"),width=4,height=3,units="in")


#plot deviation from mean
y.lim3<-c(0,5)
trav.uk.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start+2*365), xmax = as.Date(int.end+2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_hline(yintercept=1,linetype=12)+
  geom_bar(aes(x=date, y=ratio.means),stat="identity",fill="darkorange3")+
  scaleDateYr+
  pubTheme+
  labs(y="Ratio between monthly and annual\nmean daily travellers from UK", x=NULL)+
  scale_y_continuous(expand=expansion(0.01,0))
ggsave(paste0(fold.out,"Ratio monthly to annual mean daily trav from UK_All.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-100,400)
trav.uk.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=perc.dev*100),stat="identity",fill=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Percent deviation between monthly and\nannual mean daily travellers from UK", x=NULL)+
  scale_y_continuous(expand=expansion(0,0))+
  geom_hline(yintercept=0,linetype=12)
ggsave(paste0(fold.out,"Perc dev monthly to annual mean daily trav from UK_All.png"),width=4,height=3,units="in")
```

## estimate travel expected without ban
```{r}
# okay so how do we use this information to predict seasonality of covid travel from uk?
# want to know how many average daily cases were expected in the months of flight ban
# based on the observed seasonality in travel volume from UK
trav.uk.month.trends<-trav.uk.all %>% 
  filter(!year %in% c("2020","2021")) %>%
  dplyr::group_by(month) %>%
  dplyr::summarise(.groups="rowwise",
                   mean.percdev=mean(perc.dev),
                   mean.diffmeans=mean(diff.means),
                   mean.ratiomeans=mean(ratio.means))

trends.dates<-left_join(trav.uk.dates,trav.uk.month.trends,by="month")
trends.dates<-trends.dates[-which(duplicated(trends.dates$month)),]
trends.dates<-trends.dates[,-which(colnames(trends.dates) %in% c("year","monthyear","date"))]
trends.dates$month<-factor(trends.dates$month,levels=unique(trends.dates$month))
trend.dates.long<-pivot_longer(trends.dates,cols=2:4,names_to="comparison",values_to = "values") %>% as.data.frame()

col.comps<-c("aquamarine3","darkorange3")
names(col.comps)<-c("mean.diffmeans","mean.ratiomeans")

trend.dates.long %>%
  filter(comparison !="mean.percdev") %>%
  ggplot() +
  geom_bar(aes(y=values,x=month,fill=comparison),stat="identity")+
  facet_wrap(~comparison,scales="free")+
  pubTheme+
  labs(x=NULL,y="Value")+
  scale_fill_manual(values=col.comps)+
  theme(legend.position="none")

ggsave(paste0(fold.out,"Monthly trends in mean deviation_uk.png"),width=7,height=2,units="in")


trav.uk.all2<-left_join(trav.uk.all, trav.uk.month.trends, by="month")
#apply the perc deviaiton to multiply by the mean
trav.uk.all2<-trav.uk.all2 %>% mutate(
  expected.percdev=(mean.percdev * mean.trav.yr)+mean.trav.yr,
  expected.diffmeans=mean.trav.yr + mean.diffmeans,
  expected.ratiomeans=mean.trav.yr * mean.ratiomeans)

#resstructre the data frame to be long and only loook at monthly mean travellers
trav.uk.all3<-trav.uk.all2[,match(c("date",  "expected.percdev", "expected.diffmeans",
                                          "expected.ratiomeans", "mean.trav"),colnames(trav.uk.all2))]
trav.uk.all3.long<-trav.uk.all3 %>% pivot_longer(cols=2:5,names_to="calc",values_to="value")

#okayyy now have a looky across all metrics and entire time frame
cols.calc<-c(col.comps,regcol)
names(cols.calc)<-c("expected.diffmeans","expected.ratiomeans","mean.trav")
y.lim3<-c(0,3000)
trav.uk.all3.long %>%
  filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+

  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from UK", x=NULL)+
  scale_fill_manual(values=cols.calc)
ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from UK_all.png"),
       width=7,height=3,units="in")

#zoom in on 2021 only
y.lim3<-c(-1,1550)
trav.uk.all3.long %>%
  filter(date>as.Date("2020-11-30") & date<as.Date("2021-12-31")) %>%
    filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDate+
  pubTheme+
  theme(legend.position = "top")+
  labs(y="Mean daily travellers from UK", x=NULL)+
  guides(fill= guide_legend(nrow=2, title="Calculation"))+
  scale_fill_manual(values=cols.calc)

ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from UK_2021.png"),
       width=4,height=3,units="in")

```

## Apply global travel adjustment factor to travel expectations
```{r}
#join the adjust.factors on to the expected UK travel data
head(trav.uk.all3)
colnames(trav.uk.all3)[5]<-"Observed (ban)"
colnames(trav.uk.all3)[4]<-"Expected 1 (no ban)"

trav.all4.red<-trav.all4[,which(colnames(trav.all4) %in% c("date","adjust.factor"))]

trav.uk.all4<-left_join(trav.uk.all3, trav.all4.red, by="date")
head(trav.uk.all4)

#apply the adjustment factor
trav.uk.all4<- trav.uk.all4 %>% 
  mutate(expected2 = `Expected 1 (no ban)`/adjust.factor)

#plot the two expected together

colnames(trav.uk.all4)[7]<-"Expected, adjusted (no ban)"  
trav.uk.all4.long<-trav.uk.all4 %>% 
  pivot_longer(cols=2:7,names_to="calc",values_to="value")

cols.calc3<-c("darkorange3","darkcyan",regcol)
names(cols.calc3)<-c("Expected 1 (no ban)", "Expected, adjusted (no ban)", "Observed (ban)")

y.lim<-c(0,1000)
trav.uk.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected 1 (no ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2020-11-30") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from UK", x=NULL)+
    guides(fill= guide_legend(nrow=2, title="Calculation"))+
  scale_fill_manual(values=cols.calc3)

ggsave(paste0(fold.out,"Adjusted expectation mean daily UK trav_2021.png"),
         width=4,height=3,units="in")

cols.calc4<-cols.calc3[c(2,3)]
trav.uk.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2020-11-30") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=-.7,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from UK", x=NULL)+
    guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc4)

ggsave(paste0(fold.out,"Adjusted expectation only mean daily UK trav_2021.png"),
         width=4,height=3,units="in")

```
## convert monthly to rolling daily expected travel 
```{r}
#first, check the daily observed travel from uk
trav.uk.daily<-trav.uk[,which(colnames(trav.uk) %in% 
                                      c("REF_DATE","VALUE",
                                        "year","monthyear","month","date"))]

colnames(trav.uk.daily)[2]<-"Observed"

#now, leftjoin the monthyl expected data by "date" (actually month with 01)
trav.uk.all.red<-trav.uk.all4 %>% select (c("date","Expected, adjusted (no ban)",
                                                  "Observed (ban)"))
trav.uk.oe<-left_join(trav.uk.daily,trav.uk.all.red,by="date")

#rearrange and clean
trav.uk.oe<-trav.uk.oe[,c(1,3,4,5,2,7,8)]
head(trav.uk.oe)
colnames(trav.uk.oe)[c(6,7)]<-c("MonthlyAve_exp","MonthlyAve_obs")


## add a spline fit with daily predictions to this
pred.val.df<-trav.uk.oe
pred.val.df$decdate<-decimal_date(pred.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
pred.val.df$MonthlyAve_exp[str_which(pred.val.df$REF_DATE, "15",negate = T)]<-NA
pred.vals<-spline(x=pred.val.df$decdate, y=pred.val.df$MonthlyAve_exp,
                  xout=pred.val.df$decdate)
length(pred.vals$y)==nrow(pred.val.df)

#join these
pred.vals.df2<-pred.vals %>% as.data.frame()
colnames(pred.vals.df2)<-c("decdate","Expected (no ban)")
pred.vals.all<-left_join(pred.val.df,pred.vals.df2,by="decdate")
pred.vals.all.red<-pred.vals.all %>% select(c(`REF_DATE`,`Expected (no ban)`))
#now join back to obs vs expceted
trav.uk.oe2<-left_join(trav.uk.oe, pred.vals.all.red, by="REF_DATE")

trav.uk.oe2.long<-trav.uk.oe2 %>% pivot_longer(cols=5:8,names_to = "name",
                                                   values_to="value")
y.lim2<-c(0,2000)
trav.uk.oe2.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","MonthlyAve_exp"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=-0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,linetype=name),color="darkcyan")+
  labs(y="Daily travellers from UK",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  coord_cartesian(ylim=c(0,750))+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily vs average expected from UK_2021.png"),width=4,height=3,units="in")

y.lim2<-c(0,2000)
trav.uk.oe2.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from UK",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Type"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily expected vs observed from UK_2021.png"),width=4,height=3,units="in")

#smaller y

y.lim2<-c(0,500)
trav.uk.oe2.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-01-31")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from UK",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Type"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.1,0.7),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily expected vs observed from UK_2021_endJan.png"),width=3,height=3,units="in")


#Make a smoother version of the observed data
predobs.val.df<-trav.uk.oe
predobs.val.df$decdate<-decimal_date(predobs.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
predobs.val.df$MonthlyAve_obs[str_which(predobs.val.df$REF_DATE, "15",negate = T)]<-NA
predobs.vals<-spline(x=predobs.val.df$decdate, y=predobs.val.df$MonthlyAve_obs,
                  xout=predobs.val.df$decdate)
length(predobs.vals$y)==nrow(predobs.val.df)

#join these
predobs.vals.df2<-predobs.vals %>% as.data.frame()
colnames(predobs.vals.df2)<-c("decdate","Observed, smooth (ban)")
predobs.vals.all<-left_join(predobs.val.df,predobs.vals.df2,by="decdate")
predobs.vals.all.red<-predobs.vals.all %>% select(c(`REF_DATE`,`Observed, smooth (ban)`))
#now join back to obs vs expceted
trav.uk.oe3<-left_join(trav.uk.oe2, predobs.vals.all.red, by="REF_DATE")

trav.uk.oe3.long<-trav.uk.oe3 %>% pivot_longer(cols=5:9,names_to = "name",
                                                   values_to="value")
y.lim2<-c(0,2000)
trav.uk.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","MonthlyAve_obs","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=-0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from UK",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  theme(legend.position = "top")
ggsave(paste0(fold.out,"Daily smooth vs average observed from UK_2021.png"),width=4,height=3,units="in")

#okay now a final plot of observed smooth and expected daily travellers
y.lim2<-c(0,1000)
trav.uk.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from UK",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=c(0,1000))+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))

ggsave(paste0(fold.out,"Daily observed smooth vs expected from UK_2021.png"),width=4,height=3,units="in")


#okay now a final plot of observed smooth and expected daily travellers
y.lim2<-c(0,1000)
trav.uk.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from UK",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=c(0,1000))+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))

ggsave(paste0(fold.out,"Daily observed raw vs expected smooth from UK_2021.png"),width=4,height=3,units="in")

y.lim2<-c(0,410)
p.supp.uk<-trav.uk.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-01-31")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from UK",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
    theme(legend.position = c(0.1,0.8),legend.justification = c(0,0.5))
p.supp.uk
ggsave(paste0(fold.out,"Daily observed raw vs expected smooth from UK_2021 end Jan.png"),width=3,height=3,units="in")
```

## calculate the difference under the curves
```{r}
#area under expected, during ban
#sum the daily average from each day in the ban
total.expected<-trav.uk.oe3.long %>%
  filter(name %in% "Expected (no ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.expected #960

#area under observed (smooth), during ban
total.observed.smooth<-trav.uk.oe3.long %>%
  filter(name %in% "Observed, smooth (ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.smooth #1118

#actual sum of observed, during ban
total.observed.actual<-trav.uk.oe3.long %>%
  filter(name %in%"Observed" ) %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.actual #237 - big difference with the smoothed in this instance - use raw

#difference
diff.actual<-total.expected - total.observed.actual
diff.smooth<-total.expected - total.observed.smooth
diff.actual; diff.smooth #723, -158
```

## Export expected travel
```{r}
## Export expected and observed
write.csv(trav.uk.oe3, paste0(fold.out2,"trav.uk.obs-exp.csv"))
```


# Repeat for Brazil
## Read in data and plot observed travel
```{r}
## intervention:
int.yn<-TRUE
if(int.yn==T){
  #added second set here - need to test twice... blahh
  int.start<-as.Date("2021-03-30")
  int.end<-as.Date("2021-04-14")
  int.duration<-int.end-int.start
  int.descrip<-"Brazil enhanced screening"
  
  int.start.one<-as.Date("2021-01-15")
  int.end.one<-as.Date("2021-02-22")
  int.duration.one<-int.end.one-int.start.one
  int.descrip.one<-"Brazil enhanced screening"
}

#observed color for Brazil
regcol<-"#9e9ac8"

trav.brazil<-trav %>%
  filter(Country.of.residence == "Brazil")
# table(trav.brazil$Traveller.type)

#TRAVEL VOL FROM Brazil around the Gamma flight ban
y.lim<-c(min(trav.brazil$VALUE),max(trav.brazil$VALUE))

trav.brazil %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from Brazil",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0.01)))+
  pubTheme+
  scaleDateYr
ggsave(paste0(fold.out,"Daily trav from Brazil_2018to2023.png"),width=4,height=3,units="in")

#TRAVEL VOL FROM Brazil around the Gamma flight ban
y.lim<-c(0,400)
trav.brazil %>%
  filter(REF_DATE >= as.Date("2020-12-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from Brazil",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
  
ggsave(paste0(fold.out,"Daily trav from Brazil_FebtoDec2021.png"),width=4,height=3,units="in")

#how much seasonality in travel from brazil histroically?
#if we take a mean across the entire year, how much higher is travel in each month?
trav.brazil.yr<-trav.brazil %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav.yr=sum(VALUE,na.rm=T),
            mean.trav.yr=mean(VALUE,na.rm=T),
            median.trav.yr=median(VALUE,na.rm=T),
            max.trav.yr=max(VALUE,na.rm=T),
            min.trav.yr=min(VALUE,na.rm=T))
# trav.brazil.yr

trav.brazil.mo<-trav.brazil %>% 
  dplyr::group_by(monthyear) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav=sum(VALUE,na.rm=T),
            mean.trav=mean(VALUE,na.rm=T),
            median.trav=median(VALUE,na.rm=T),
            max.trav=max(VALUE,na.rm=T),
            min.trav=min(VALUE,na.rm=T)) 
# head(trav.brazil.mo)

#join together using dates
trav.brazil.dates<-trav.brazil[,c("year","month","monthyear","date")]
trav.brazil.dates<-trav.brazil.dates[-which(duplicated(trav.brazil.dates$monthyear)),]
trav.brazil.mo<-left_join(trav.brazil.mo, trav.brazil.dates,by="monthyear")
trav.brazil.all<-left_join(trav.brazil.mo,trav.brazil.yr, by="year")
# head(trav.brazil.all)

#for each month, calculate % dev relative to mean
trav.brazil.all<-trav.brazil.all %>% mutate(diff.means=mean.trav - mean.trav.yr,
                                          ratio.means=mean.trav/mean.trav.yr,
                                          perc.dev=diff.means / mean.trav.yr) %>%   as.data.frame()
# head(trav.brazil.all)


# PLOT IT UPPP
y.lim3<-c(0,380)
trav.brazil.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Brazil", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from Brazil_All.png"),width=4,height=3,units="in")

#highlight thsese months in each year
trav.brazil.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  #MORE RECTS
  annotate(geom="rect",xmin = as.Date(int.start.one-365), xmax = as.Date(int.end.one-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one-2*365), xmax = as.Date(int.end.one-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one-3*365), xmax = as.Date(int.end.one-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one+365), xmax = as.Date(int.end.one+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Brazil", x=NULL)
ggsave(paste0(fold.out,"extra highlights Mean daily trav from Brazil_All.png"),width=4,height=3,units="in")

#fit a spline
trav.brazil.all %>%
  ggplot()+
  geom_smooth(aes(x=date, y=mean.trav),stat="identity",color=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Brazil", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from Brazil_All_line.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-150,160)
trav.brazil.all %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
     annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+2*365), xmax = as.Date(int.end+2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+ 
   annotate(geom="rect",xmin = as.Date(int.start.one-365), xmax = as.Date(int.end.one-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one-2*365), xmax = as.Date(int.end.one-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one-3*365), xmax = as.Date(int.end.one-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one+365), xmax = as.Date(int.end.one+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=diff.means),stat="identity",fill="aquamarine3")+
  scaleDateYr+
  pubTheme+
  scale_y_continuous(expand=expansion(0,0))+
  labs(y="Difference between monthly and annual\nmean daily travellers from Brazil", x=NULL)
ggsave(paste0(fold.out,"Diff monthly to annual mean daily trav from Brazil_All.png"),width=4,height=3,units="in")


#plot deviation from mean
y.lim3<-c(0,5)
trav.brazil.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start+2*365), xmax = as.Date(int.end+2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one-365), xmax = as.Date(int.end.one-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one-2*365), xmax = as.Date(int.end.one-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one-3*365), xmax = as.Date(int.end.one-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start.one+365), xmax = as.Date(int.end.one+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_hline(yintercept=1,linetype=12)+
  geom_bar(aes(x=date, y=ratio.means),stat="identity",fill="darkorange3")+
  scaleDateYr+
  pubTheme+
  labs(y="Ratio between monthly and annual\nmean daily travellers from Brazil", x=NULL)+
  scale_y_continuous(expand=expansion(0.01,0))
ggsave(paste0(fold.out,"Ratio monthly to annual mean daily trav from Brazil_All.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-120,500)
trav.brazil.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=perc.dev*100),stat="identity",fill=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Percent deviation between monthly and\nannual mean daily travellers from Brazil", x=NULL)+
  scale_y_continuous(expand=expansion(0,0))+
  geom_hline(yintercept=0,linetype=12)
ggsave(paste0(fold.out,"Perc dev monthly to annual mean daily trav from Brazil_All.png"),width=4,height=3,units="in")
```

## estimate travel expected without ban
```{r}
# okay so how do we use this information to predict seasonality of covid travel from brazil?
# want to know how many average daily cases were expected in the months of flight ban
# based on the observed seasonality in travel volume from Brazil
trav.brazil.month.trends<-trav.brazil.all %>% 
  filter(!year %in% c("2020","2021")) %>%
  dplyr::group_by(month) %>%
  dplyr::summarise(.groups="rowwise",
                   mean.percdev=mean(perc.dev),
                   mean.diffmeans=mean(diff.means),
                   mean.ratiomeans=mean(ratio.means))

trends.dates<-left_join(trav.brazil.dates,trav.brazil.month.trends,by="month")
trends.dates<-trends.dates[-which(duplicated(trends.dates$month)),]
trends.dates<-trends.dates[,-which(colnames(trends.dates) %in% c("year","monthyear","date"))]
trends.dates$month<-factor(trends.dates$month,levels=unique(trends.dates$month))
trend.dates.long<-pivot_longer(trends.dates,cols=2:4,names_to="comparison",values_to = "values") %>% as.data.frame()

col.comps<-c("aquamarine3","darkorange3")
names(col.comps)<-c("mean.diffmeans","mean.ratiomeans")

trend.dates.long %>%
  filter(comparison !="mean.percdev") %>%
  ggplot() +
  geom_bar(aes(y=values,x=month,fill=comparison),stat="identity")+
  facet_wrap(~comparison,scales="free")+
  pubTheme+
  labs(x=NULL,y="Value")+
  scale_fill_manual(values=col.comps)+
  theme(legend.position="none")

ggsave(paste0(fold.out,"Monthly trends in mean deviation_brazil.png"),width=7,height=2,units="in")


trav.brazil.all2<-left_join(trav.brazil.all, trav.brazil.month.trends, by="month")
#apply the perc deviaiton to multiply by the mean
trav.brazil.all2<-trav.brazil.all2 %>% mutate(
  expected.percdev=(mean.percdev * mean.trav.yr)+mean.trav.yr,
  expected.diffmeans=mean.trav.yr + mean.diffmeans,
  expected.ratiomeans=mean.trav.yr * mean.ratiomeans)

#resstructre the data frame to be long and only loook at monthly mean travellers
trav.brazil.all3<-trav.brazil.all2[,match(c("date",  "expected.percdev", "expected.diffmeans",
                                          "expected.ratiomeans", "mean.trav"),colnames(trav.brazil.all2))]
trav.brazil.all3.long<-trav.brazil.all3 %>% pivot_longer(cols=2:5,names_to="calc",values_to="value")

#okayyy now have a looky across all metrics and entire time frame
cols.calc<-c(col.comps,regcol)
names(cols.calc)<-c("expected.diffmeans","expected.ratiomeans","mean.trav")
y.lim3<-c(0,400)
trav.brazil.all3.long %>%
  filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+

  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Brazil", x=NULL)+
  scale_fill_manual(values=cols.calc)
ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from Brazil_all.png"),
       width=7,height=3,units="in")

#zoom in on 2021 only
y.lim3<-c(-1,200)
trav.brazil.all3.long %>%
  filter(date>as.Date("2020-11-30") & date<as.Date("2021-12-31")) %>%
    filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDate+
  pubTheme+
  theme(legend.position = "top")+
  labs(y="Mean daily travellers from Brazil", x=NULL)+
  guides(fill= guide_legend(nrow=2, title="Calculation"))+
  scale_fill_manual(values=cols.calc)

ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from Brazil_2021.png"),
       width=4,height=3,units="in")

```

## Apply global travel adjustment factor to travel expectations
```{r}
#join the adjust.factors on to the expected Brazil travel data
colnames(trav.brazil.all3)[5]<-"Observed (ban)"
colnames(trav.brazil.all3)[4]<-"Expected 1 (no ban)"

trav.all4.red<-trav.all4[,which(colnames(trav.all4) %in% c("date","adjust.factor"))]

trav.brazil.all4<-left_join(trav.brazil.all3, trav.all4.red, by="date")
# head(trav.brazil.all4)

#apply the adjustment factor
trav.brazil.all4<- trav.brazil.all4 %>% 
  mutate(expected2 = `Expected 1 (no ban)`/adjust.factor)

#plot the two expected together

colnames(trav.brazil.all4)[7]<-"Expected, adjusted (no ban)"  
trav.brazil.all4.long<-trav.brazil.all4 %>% 
  pivot_longer(cols=2:7,names_to="calc",values_to="value")

cols.calc3<-c("darkorange3","darkcyan",regcol)
names(cols.calc3)<-c("Expected 1 (no ban)", "Expected, adjusted (no ban)", "Observed (ban)")

y.lim<-c(0,200)
trav.brazil.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected 1 (no ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2020-11-30") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
     annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from Brazil", x=NULL)+
    guides(fill= guide_legend(nrow=2, title="Calculation"))+
  scale_fill_manual(values=cols.calc3)

ggsave(paste0(fold.out,"Adjusted expectation mean daily Brazil trav_2021.png"),
         width=4,height=3,units="in")

cols.calc4<-cols.calc3[c(2,3)]
trav.brazil.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2020-11-30") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
     annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from Brazil", x=NULL)+
    guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc4)

ggsave(paste0(fold.out,"Adjusted expectation only mean daily Brazil trav_2021.png"),
         width=4,height=3,units="in")
```
## convert monthly to rolling daily expected travel 
```{r}
#first, check the daily observed travel from brazil
trav.brazil.daily<-trav.brazil[,which(colnames(trav.brazil) %in% 
                                      c("REF_DATE","VALUE",
                                        "year","monthyear","month","date"))]

colnames(trav.brazil.daily)[2]<-"Observed"

#now, leftjoin the monthyl expected data by "date" (actually month with 01)
trav.brazil.all.red<-trav.brazil.all4 %>% select (c("date","Expected, adjusted (no ban)",
                                                  "Observed (ban)"))
trav.brazil.oe<-left_join(trav.brazil.daily,trav.brazil.all.red,by="date")

#rearrange and clean
trav.brazil.oe<-trav.brazil.oe[,c(1,3,4,5,2,7,8)]
head(trav.brazil.oe)
colnames(trav.brazil.oe)[c(6,7)]<-c("MonthlyAve_exp","MonthlyAve_obs")


## add a spline fit with daily predictions to this
pred.val.df<-trav.brazil.oe
pred.val.df$decdate<-decimal_date(pred.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
pred.val.df$MonthlyAve_exp[str_which(pred.val.df$REF_DATE, "15",negate = T)]<-NA
pred.vals<-spline(x=pred.val.df$decdate, y=pred.val.df$MonthlyAve_exp,
                  xout=pred.val.df$decdate)
length(pred.vals$y)==nrow(pred.val.df)

#join these
pred.vals.df2<-pred.vals %>% as.data.frame()
colnames(pred.vals.df2)<-c("decdate","Expected (no ban)")
pred.vals.all<-left_join(pred.val.df,pred.vals.df2,by="decdate")
pred.vals.all.red<-pred.vals.all %>% select(c(`REF_DATE`,`Expected (no ban)`))
#now join back to obs vs expceted
trav.brazil.oe2<-left_join(trav.brazil.oe, pred.vals.all.red, by="REF_DATE")

trav.brazil.oe2.long<-trav.brazil.oe2 %>% pivot_longer(cols=5:8,names_to = "name",
                                                   values_to="value")
y.lim2<-c(0,180)
trav.brazil.oe2.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","MonthlyAve_exp"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,linetype=name),color="darkcyan")+
  labs(y="Daily travellers from Brazil",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  coord_cartesian(ylim=c(0,180))+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily vs average expected from Brazil_2021.png"),width=4,height=3,units="in")

y.lim2<-c(0,400)
trav.brazil.oe2.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Brazil",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Type"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily expected vs observed from Brazil_2021.png"),width=4,height=3,units="in")


y.lim2<-c(0,20)
trav.brazil.oe2.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-05-31")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.8,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Brazil",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Type"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.01,0.96),legend.justification = c(0,1))
ggsave(paste0(fold.out,"Daily expected vs observed from Brazil_2021winter.png"),width=4,height=3,units="in")

#Make a smoother version of the observed data
predobs.val.df<-trav.brazil.oe
predobs.val.df$decdate<-decimal_date(predobs.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
predobs.val.df$MonthlyAve_obs[str_which(predobs.val.df$REF_DATE, "15",negate = T)]<-NA
predobs.vals<-spline(x=predobs.val.df$decdate, y=predobs.val.df$MonthlyAve_obs,
                  xout=predobs.val.df$decdate)
length(predobs.vals$y)==nrow(predobs.val.df)

#join these
predobs.vals.df2<-predobs.vals %>% as.data.frame()
colnames(predobs.vals.df2)<-c("decdate","Observed, smooth (ban)")
predobs.vals.all<-left_join(predobs.val.df,predobs.vals.df2,by="decdate")
predobs.vals.all.red<-predobs.vals.all %>% select(c(`REF_DATE`,`Observed, smooth (ban)`))
#now join back to obs vs expceted
trav.brazil.oe3<-left_join(trav.brazil.oe2, predobs.vals.all.red, by="REF_DATE")

trav.brazil.oe3.long<-trav.brazil.oe3 %>% pivot_longer(cols=5:9,names_to = "name",
                                                   values_to="value")

y.lim2<-c(0,400)
trav.brazil.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","MonthlyAve_obs","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Brazil",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
ggsave(paste0(fold.out,"Daily smooth,daily, vs average observed from Brazil_2021.png"),width=4,height=3,units="in")

#okay now a final plot of observed smooth and expected daily travellers
y.lim2<-c(0,400)
trav.brazil.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name),alpha=0.9)+
  labs(y="Daily travellers from Brazil",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=c(0,400))+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily observed smooth vs expected from Brazil_2021.png"),width=4,height=3,units="in")

trav.brazil.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-05-01")) %>%
  filter(name %in% c("Observed, smooth (ban)","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=1,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name),alpha=0.9)+
  labs(y="Daily travellers from Brazil",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=c(0,20))+
    theme(legend.position = c(0.01,0.95),legend.justification = c(0,1))
ggsave(paste0(fold.out,"Daily observed smooth vs expected from Brazil_2021winter.png"),width=4,height=3,units="in")

## RAW COUNTS
y.lim2<-c(0,25)
p.supp.braz<-trav.brazil.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-05-01")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start.one), xmax = as.Date(int.end.one),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=1,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name),alpha=0.9)+
  labs(y="Daily travellers from Brazil",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
  theme(legend.position = c(0.1,0.8),legend.justification = c(0,0.5))
p.supp.braz
ggsave(paste0(fold.out,"Daily observed raw vs expected from Brazil_2021winter.png"),width=3,height=3,units="in")
```

## calculate the difference under the curves
```{r}
#area under expected, during ban
#sum the daily average from each day in the ban
total.expected<-trav.brazil.oe3.long %>%
  filter(name %in% "Expected (no ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end |
           REF_DATE >= int.start.one & REF_DATE <= int.end.one ) %>%
  summarize(total=sum(value)) %>% as.integer()
total.expected #435

#area under observed (smooth), during ban
total.observed.smooth<-trav.brazil.oe3.long %>%
  filter(name %in% "Observed, smooth (ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end |
           REF_DATE >= int.start.one & REF_DATE <= int.end.one ) %>%  
  summarize(total=sum(value)) %>% as.integer()
total.observed.smooth #68

#actual sum of observed, during ban
total.observed.actual<-trav.brazil.oe3.long %>%
  filter(name %in%"Observed" ) %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end |
           REF_DATE >= int.start.one & REF_DATE <= int.end.one ) %>%  
  summarize(total=sum(value)) %>% as.integer()
total.observed.actual #52

#difference
diff.actual<-total.expected - total.observed.actual
diff.smooth<-total.expected - total.observed.smooth
diff.actual; diff.smooth #383, 367
```

## Export expected travel
```{r}
## Export expected and observed
write.csv(trav.brazil.oe3, paste0(fold.out2,"trav.brazil.obs-exp.csv"))
```

# Repeat for South Africa, Beta
## Read in data and plot observed travel
```{r}
## intervention:
int.yn<-TRUE
if(int.yn==T){
  int.start<-as.Date("2020-12-24")
  int.end<-as.Date("2021-02-22")
  int.duration<-int.end-int.start
  int.descrip<-"South Africa enhanced screening"
}

#observed color for South Africa
regcol<- "#f768a1"

trav.southafrica<-trav %>%
  filter(Country.of.residence ==  "South Africa, Republic of")
table(trav.southafrica$Traveller.type)

#TRAVEL VOL FROM South Africa around the ban
y.lim<-c(min(trav.southafrica$VALUE),max(trav.southafrica$VALUE))

trav.southafrica %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from South Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0.01)))+
  pubTheme+
  scaleDateYr
ggsave(paste0(fold.out,"Daily trav from South Africa_2018to2023.png"),width=4,height=3,units="in")

#TRAVEL VOL FROM South Africa around the Alpha flight ban
y.lim2<-c(0,120)
trav.southafrica %>%
  filter(REF_DATE >= as.Date("2020-12-01")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from South Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
  
ggsave(paste0(fold.out,"Daily trav from South Africa_FebtoDec2021.png"),width=4,height=3,units="in")

#how much seasonality in travel from southafrica histroically?
#if we take a mean across the entire year, how much higher is travel in each month?
trav.southafrica.yr<-trav.southafrica %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav.yr=sum(VALUE,na.rm=T),
            mean.trav.yr=mean(VALUE,na.rm=T),
            median.trav.yr=median(VALUE,na.rm=T),
            max.trav.yr=max(VALUE,na.rm=T),
            min.trav.yr=min(VALUE,na.rm=T))
# trav.southafrica.yr

trav.southafrica.mo<-trav.southafrica %>% 
  dplyr::group_by(monthyear) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav=sum(VALUE,na.rm=T),
            mean.trav=mean(VALUE,na.rm=T),
            median.trav=median(VALUE,na.rm=T),
            max.trav=max(VALUE,na.rm=T),
            min.trav=min(VALUE,na.rm=T)) 
# head(trav.southafrica.mo)

#join together using dates
trav.southafrica.dates<-trav.southafrica[,c("year","month","monthyear","date")]
trav.southafrica.dates<-trav.southafrica.dates[-which(duplicated(trav.southafrica.dates$monthyear)),]
trav.southafrica.mo<-left_join(trav.southafrica.mo, trav.southafrica.dates,by="monthyear")
trav.southafrica.all<-left_join(trav.southafrica.mo,trav.southafrica.yr, by="year")
# head(trav.southafrica.all)

#for each month, calculate % dev relative to mean
trav.southafrica.all<-trav.southafrica.all %>% mutate(diff.means=mean.trav - mean.trav.yr,
                                          ratio.means=mean.trav/mean.trav.yr,
                                          perc.dev=diff.means / mean.trav.yr) %>%   as.data.frame()
# head(trav.southafrica.all)


# PLOT IT UPPP
y.lim3<-c(0,80)
trav.southafrica.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from South Africa", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from South Africa_All.png"),width=4,height=3,units="in")

#highlight thsese months in each year
trav.southafrica.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from South Africa", x=NULL)
ggsave(paste0(fold.out,"extra highlights Mean daily trav from South Africa_All.png"),width=4,height=3,units="in")

#fit a spline
trav.southafrica.all %>%
  ggplot()+
  geom_smooth(aes(x=date, y=mean.trav),stat="identity",color=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from South Africa", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from South Africa_All_line.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-25,50)
trav.southafrica.all %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+2*365), xmax = as.Date(int.end+2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+ 
  geom_bar(aes(x=date, y=diff.means),stat="identity",fill="aquamarine3")+
  scaleDateYr+
  pubTheme+
  scale_y_continuous(expand=expansion(0,0))+
  labs(y="Difference between monthly and annual\nmean daily travellers from South Africa", x=NULL)
ggsave(paste0(fold.out,"Diff monthly to annual mean daily trav from South Africa_All.png"),width=4,height=3,units="in")


#plot deviation from mean
y.lim3<-c(0,5)
trav.southafrica.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start+2*365), xmax = as.Date(int.end+2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_hline(yintercept=1,linetype=12)+
  geom_bar(aes(x=date, y=ratio.means),stat="identity",fill="darkorange3")+
  scaleDateYr+
  pubTheme+
  labs(y="Ratio between monthly and annual\nmean daily travellers from South Africa", x=NULL)+
  scale_y_continuous(expand=expansion(0.01,0))
ggsave(paste0(fold.out,"Ratio monthly to annual mean daily trav from South Africa_All.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-100,400)
trav.southafrica.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=perc.dev*100),stat="identity",fill=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Percent deviation between monthly and\nannual mean daily travellers from South Africa", x=NULL)+
  scale_y_continuous(expand=expansion(0,0))+
  geom_hline(yintercept=0,linetype=12)
ggsave(paste0(fold.out,"Perc dev monthly to annual mean daily trav from South Africa_All.png"),width=4,height=3,units="in")
```

## estimate travel expected without ban
```{r}
# okay so how do we use this information to predict seasonality of covid travel from southafrica?
# want to know how many average daily cases were expected in the months of flight ban
# based on the observed seasonality in travel volume from South Africa
trav.southafrica.month.trends<-trav.southafrica.all %>% 
  filter(!year %in% c("2020","2021")) %>%
  dplyr::group_by(month) %>%
  dplyr::summarise(.groups="rowwise",
                   mean.percdev=mean(perc.dev),
                   mean.diffmeans=mean(diff.means),
                   mean.ratiomeans=mean(ratio.means))

trends.dates<-left_join(trav.southafrica.dates,trav.southafrica.month.trends,by="month")
trends.dates<-trends.dates[-which(duplicated(trends.dates$month)),]
trends.dates<-trends.dates[,-which(colnames(trends.dates) %in% c("year","monthyear","date"))]
trends.dates$month<-factor(trends.dates$month,levels=unique(trends.dates$month))
trend.dates.long<-pivot_longer(trends.dates,cols=2:4,names_to="comparison",values_to = "values") %>% as.data.frame()

col.comps<-c("aquamarine3","darkorange3")
names(col.comps)<-c("mean.diffmeans","mean.ratiomeans")

trend.dates.long %>%
  filter(comparison !="mean.percdev") %>%
  ggplot() +
  geom_bar(aes(y=values,x=month,fill=comparison),stat="identity")+
  facet_wrap(~comparison,scales="free")+
  pubTheme+
  labs(x=NULL,y="Value")+
  scale_fill_manual(values=col.comps)+
  theme(legend.position="none")

ggsave(paste0(fold.out,"Monthly trends in mean deviation_southafrica.png"),width=7,height=2,units="in")


trav.southafrica.all2<-left_join(trav.southafrica.all, trav.southafrica.month.trends, by="month")
#apply the perc deviaiton to multiply by the mean
trav.southafrica.all2<-trav.southafrica.all2 %>% mutate(
  expected.percdev=(mean.percdev * mean.trav.yr)+mean.trav.yr,
  expected.diffmeans=mean.trav.yr + mean.diffmeans,
  expected.ratiomeans=mean.trav.yr * mean.ratiomeans)

#resstructre the data frame to be long and only loook at monthly mean travellers
trav.southafrica.all3<-trav.southafrica.all2[,match(c("date",  "expected.percdev", "expected.diffmeans",
                                          "expected.ratiomeans", "mean.trav"),colnames(trav.southafrica.all2))]
trav.southafrica.all3.long<-trav.southafrica.all3 %>% pivot_longer(cols=2:5,names_to="calc",values_to="value")

#okayyy now have a looky across all metrics and entire time frame
cols.calc<-c(col.comps,regcol)
names(cols.calc)<-c("expected.diffmeans","expected.ratiomeans","mean.trav")
y.lim3<-c(0,80)
trav.southafrica.all3.long %>%
  filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+

  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from South Africa", x=NULL)+
  scale_fill_manual(values=cols.calc)
ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from South Africa_all.png"),
       width=7,height=3,units="in")

#zoom in on 2021 only
y.lim3<-c(-1,40)
trav.southafrica.all3.long %>%
  filter(date>as.Date("2020-11-30") & date<as.Date("2021-12-31")) %>%
    filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDate+
  pubTheme+
  theme(legend.position = "top")+
  labs(y="Mean daily travellers from South Africa", x=NULL)+
  guides(fill= guide_legend(nrow=2, title="Calculation"))+
  scale_fill_manual(values=cols.calc)

ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from South Africa_2021.png"),
       width=4,height=3,units="in")

```

## Apply global travel adjustment factor to travel expectations
```{r}
#join the adjust.factors on to the expected South Africa travel data
# head(trav.southafrica.all3)
colnames(trav.southafrica.all3)[5]<-"Observed (ban)"
colnames(trav.southafrica.all3)[4]<-"Expected 1 (no ban)"

trav.all4.red<-trav.all4[,which(colnames(trav.all4) %in% c("date","adjust.factor"))]

trav.southafrica.all4<-left_join(trav.southafrica.all3, trav.all4.red, by="date")
# head(trav.southafrica.all4)

#apply the adjustment factor
trav.southafrica.all4<- trav.southafrica.all4 %>% 
  mutate(expected2 = `Expected 1 (no ban)`/adjust.factor)

#plot the two expected together

colnames(trav.southafrica.all4)[7]<-"Expected, adjusted (no ban)"  
trav.southafrica.all4.long<-trav.southafrica.all4 %>% 
  pivot_longer(cols=2:7,names_to="calc",values_to="value")

cols.calc3<-c("darkorange3","darkcyan",regcol)
names(cols.calc3)<-c("Expected 1 (no ban)", "Expected, adjusted (no ban)", "Observed (ban)")

y.lim<-c(0,35)
trav.southafrica.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected 1 (no ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2020-11-30") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from South Africa", x=NULL)+
    guides(fill= guide_legend(nrow=2, title="Calculation"))+
  scale_fill_manual(values=cols.calc3)

ggsave(paste0(fold.out,"Adjusted expectation mean daily South Africa trav_2021.png"),
         width=4,height=3,units="in")

cols.calc4<-cols.calc3[c(2,3)]
trav.southafrica.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2020-11-30") & date<as.Date("2021-12-31")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=.7,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from South Africa", x=NULL)+
    guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc4)

ggsave(paste0(fold.out,"Adjusted expectation only mean daily South Africa trav_2021.png"),
         width=4,height=3,units="in")

```
## convert monthly to rolling daily expected travel 
```{r}
#first, check the daily observed travel from southafrica
trav.southafrica.daily<-trav.southafrica[,which(colnames(trav.southafrica) %in% 
                                      c("REF_DATE","VALUE",
                                        "year","monthyear","month","date"))]

colnames(trav.southafrica.daily)[2]<-"Observed"

#now, leftjoin the monthyl expected data by "date" (actually month with 01)
trav.southafrica.all.red<-trav.southafrica.all4 %>% select (c("date","Expected, adjusted (no ban)",
                                                  "Observed (ban)"))
trav.southafrica.oe<-left_join(trav.southafrica.daily,trav.southafrica.all.red,by="date")

#rearrange and clean
trav.southafrica.oe<-trav.southafrica.oe[,c(1,3,4,5,2,7,8)]
head(trav.southafrica.oe)
colnames(trav.southafrica.oe)[c(6,7)]<-c("MonthlyAve_exp","MonthlyAve_obs")


## add a spline fit with daily predictions to this
pred.val.df<-trav.southafrica.oe
pred.val.df$decdate<-decimal_date(pred.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
pred.val.df$MonthlyAve_exp[str_which(pred.val.df$REF_DATE, "15",negate = T)]<-NA
pred.vals<-spline(x=pred.val.df$decdate, y=pred.val.df$MonthlyAve_exp,
                  xout=pred.val.df$decdate)
length(pred.vals$y)==nrow(pred.val.df)

#join these
pred.vals.df2<-pred.vals %>% as.data.frame()
colnames(pred.vals.df2)<-c("decdate","Expected (no ban)")
pred.vals.all<-left_join(pred.val.df,pred.vals.df2,by="decdate")
pred.vals.all.red<-pred.vals.all %>% select(c(`REF_DATE`,`Expected (no ban)`))
#now join back to obs vs expceted
trav.southafrica.oe2<-left_join(trav.southafrica.oe, pred.vals.all.red, by="REF_DATE")

trav.southafrica.oe2.long<-trav.southafrica.oe2 %>% pivot_longer(cols=5:8,names_to = "name",
                                                   values_to="value")
y.lim2<-c(0,35)
trav.southafrica.oe2.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","MonthlyAve_exp"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=-0.2,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,linetype=name),color="darkcyan")+
  labs(y="Daily travellers from South Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  coord_cartesian(ylim=c(0,35))+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily vs average expected from South Africa_2021.png"),width=4,height=3,units="in")

y.lim2<-c(0,120)
trav.southafrica.oe2.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from South Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Type"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))
ggsave(paste0(fold.out,"Daily expected vs observed from South Africa_2021.png"),width=4,height=3,units="in")

#Make a smoother version of the observed data
predobs.val.df<-trav.southafrica.oe
predobs.val.df$decdate<-decimal_date(predobs.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
predobs.val.df$MonthlyAve_obs[str_which(predobs.val.df$REF_DATE, "15",negate = T)]<-NA
predobs.vals<-spline(x=predobs.val.df$decdate, y=predobs.val.df$MonthlyAve_obs,
                  xout=predobs.val.df$decdate)
length(predobs.vals$y)==nrow(predobs.val.df)

#join these
predobs.vals.df2<-predobs.vals %>% as.data.frame()
colnames(predobs.vals.df2)<-c("decdate","Observed, smooth (ban)")
predobs.vals.all<-left_join(predobs.val.df,predobs.vals.df2,by="decdate")
predobs.vals.all.red<-predobs.vals.all %>% select(c(`REF_DATE`,`Observed, smooth (ban)`))
#now join back to obs vs expceted
trav.southafrica.oe3<-left_join(trav.southafrica.oe2, predobs.vals.all.red, by="REF_DATE")

trav.southafrica.oe3.long<-trav.southafrica.oe3 %>% pivot_longer(cols=5:9,names_to = "name",
                                                   values_to="value")

trav.southafrica.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","MonthlyAve_obs","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from South Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
ggsave(paste0(fold.out,"Daily smooth,daily, vs average observed from South Africa_2021.png"),width=4,height=3,units="in")

#okay now a final plot of observed smooth and expected daily travellers
y.lim2<-c(0,120)
trav.southafrica.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-12-31")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from South Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=c(0,80))+
    theme(legend.position = c(0.1,0.5),legend.justification = c(0,0.5))


ggsave(paste0(fold.out,"Daily observed raw vs expected from South Africa_2021.png"),width=4,height=3,units="in")


#okay now a final plot of observed smooth and expected daily travellers
y.lim2<-c(0,22)
p.supp.southafr<-trav.southafrica.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-03-31")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)-7,y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from South Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
    theme(legend.position = c(0.1,0.8),legend.justification = c(0,0.5))

p.supp.southafr
ggsave(paste0(fold.out,"Daily observed raw vs expected from South Africa_2021.png"),width=3,height=3,units="in")

##SMOOTH version
#okay now a final plot of observed smooth and expected daily travellers
y.lim2<-c(0,20)
trav.southafrica.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-11-30")) %>%
  filter(REF_DATE < as.Date("2021-03-31")) %>%
  filter(name %in% c("Observed, smooth (ban)","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from South Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
    theme(legend.position = c(0.2,0.7),legend.justification = c(0,0.5))

ggsave(paste0(fold.out,"Daily observed smooth vs expected from South Africa_2021.png"),width=3,height=3,units="in")


```



## calculate the difference under the curves
```{r}
#area under expected, during ban
#sum the daily average from each day in the ban
total.expected<-trav.southafrica.oe3.long %>%
  filter(name %in% "Expected (no ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.expected #99

#area under observed (smooth), during ban
total.observed.smooth<-trav.southafrica.oe3.long %>%
  filter(name %in% "Observed, smooth (ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.smooth #114

#actual sum of observed, during ban
total.observed.actual<-trav.southafrica.oe3.long %>%
  filter(name %in%"Observed" ) %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.actual #96

#difference
diff.actual<-total.expected - total.observed.actual
diff.smooth<-total.expected - total.observed.smooth
diff.actual; diff.smooth #3, -15
## NO CHANGE IN NUMBER OF TRAVELLERS FOLLOWING THIs BAN
```

## Export expected travel
```{r}
## Export expected and observed
write.csv(trav.southafrica.oe3, paste0(fold.out2,"trav.southafrica-beta.obs-exp.csv"))
```



# Repeat for Africa, Omicron
## Read in data and plot observed travel
```{r}
## intervention:
int.yn<-TRUE
if(int.yn==T){
  int.start<-as.Date("2021-11-26")
  int.end<-as.Date("2021-12-18")
  int.duration<-int.end-int.start
  int.descrip<-"Southern Africa entry ban"
}

#observed color for Africa
regcol<-"#ae017e" 

trav.africa<-trav %>%
  filter(Country.of.residence ==  "Africa")
table(trav.africa$Traveller.type)

#TRAVEL VOL FROM Africa around the ban
y.lim<-c(min(trav.africa$VALUE),max(trav.africa$VALUE))

trav.africa %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0.9,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0.01)))+
  pubTheme+
  scaleDateYr
ggsave(paste0(fold.out,"Daily trav from Africa_2018to2023.png"),width=4,height=3,units="in")

#TRAVEL VOL FROM Africa around the Alpha flight ban
y.lim2<-c(0,410)
trav.africa %>%
  filter(REF_DATE >= as.Date("2021-10-01")) %>%
  filter(REF_DATE < as.Date("2022-01-30")) %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.4,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=VALUE),color=regcol)+
  labs(y="Daily travellers from Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
  
ggsave(paste0(fold.out,"Daily trav from Africa_Oct2021toFeb2022.png"),width=4,height=3,units="in")

#how much seasonality in travel from africa histroically?
#if we take a mean across the entire year, how much higher is travel in each month?
trav.africa.yr<-trav.africa %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav.yr=sum(VALUE,na.rm=T),
            mean.trav.yr=mean(VALUE,na.rm=T),
            median.trav.yr=median(VALUE,na.rm=T),
            max.trav.yr=max(VALUE,na.rm=T),
            min.trav.yr=min(VALUE,na.rm=T))
# trav.africa.yr

trav.africa.mo<-trav.africa %>% 
  dplyr::group_by(monthyear) %>% 
  dplyr::summarize(.groups="rowwise", 
            total.trav=sum(VALUE,na.rm=T),
            mean.trav=mean(VALUE,na.rm=T),
            median.trav=median(VALUE,na.rm=T),
            max.trav=max(VALUE,na.rm=T),
            min.trav=min(VALUE,na.rm=T)) 
# head(trav.africa.mo)

#join together using dates
trav.africa.dates<-trav.africa[,c("year","month","monthyear","date")]
trav.africa.dates<-trav.africa.dates[-which(duplicated(trav.africa.dates$monthyear)),]
trav.africa.mo<-left_join(trav.africa.mo, trav.africa.dates,by="monthyear")
trav.africa.all<-left_join(trav.africa.mo,trav.africa.yr, by="year")
# head(trav.africa.all)

#for each month, calculate % dev relative to mean
trav.africa.all<-trav.africa.all %>% mutate(diff.means=mean.trav - mean.trav.yr,
                                          ratio.means=mean.trav/mean.trav.yr,
                                          perc.dev=diff.means / mean.trav.yr) %>%   as.data.frame()
# head(trav.africa.all)


# PLOT IT UPPP
y.lim3<-c(0,520)
trav.africa.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.6,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Africa", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from Africa_All.png"),width=4,height=3,units="in")

#highlight thsese months in each year
trav.africa.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.6,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=mean.trav),stat="identity",fill=regcol)+
  geom_line(aes(x=date,y=mean.trav.yr))+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Africa", x=NULL)
ggsave(paste0(fold.out,"extra highlights Mean daily trav from Africa_All.png"),width=4,height=3,units="in")

#fit a spline
trav.africa.all %>%
  ggplot()+
  geom_smooth(aes(x=date, y=mean.trav),stat="identity",color=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Africa", x=NULL)
ggsave(paste0(fold.out,"Mean daily trav from Africa_All_line.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-200,250)
trav.africa.all %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+2*365), xmax = as.Date(int.end+2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+ 
  geom_bar(aes(x=date, y=diff.means),stat="identity",fill="aquamarine3")+
  scaleDateYr+
  pubTheme+
  scale_y_continuous(expand=expansion(0,0))+
  labs(y="Difference between monthly and annual\nmean daily travellers from Africa", x=NULL)
ggsave(paste0(fold.out,"Diff monthly to annual mean daily trav from Africa_All.png"),width=4,height=3,units="in")


#plot deviation from mean
y.lim3<-c(0,5)
trav.africa.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
    annotate(geom="rect",xmin = as.Date(int.start+2*365), xmax = as.Date(int.end+2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_hline(yintercept=1,linetype=12)+
  geom_bar(aes(x=date, y=ratio.means),stat="identity",fill="darkorange3")+
  scaleDateYr+
  pubTheme+
  labs(y="Ratio between monthly and annual\nmean daily travellers from Africa", x=NULL)+
  scale_y_continuous(expand=expansion(0.01,0))
ggsave(paste0(fold.out,"Ratio monthly to annual mean daily trav from Africa_All.png"),width=4,height=3,units="in")

#plot deviation from mean
y.lim3<-c(-100,400)
trav.africa.all %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=perc.dev*100),stat="identity",fill=regcol)+
  scaleDateYr+
  pubTheme+
  labs(y="Percent deviation between monthly and\nannual mean daily travellers from Africa", x=NULL)+
  scale_y_continuous(expand=expansion(0,0))+
  geom_hline(yintercept=0,linetype=12)
ggsave(paste0(fold.out,"Perc dev monthly to annual mean daily trav from Africa_All.png"),width=4,height=3,units="in")
```

## estimate travel expected without ban
```{r}
# okay so how do we use this information to predict seasonality of covid travel from africa?
# want to know how many average daily cases were expected in the months of flight ban
# based on the observed seasonality in travel volume from Africa
trav.africa.month.trends<-trav.africa.all %>% 
  filter(!year %in% c("2020","2021")) %>%
  dplyr::group_by(month) %>%
  dplyr::summarise(.groups="rowwise",
                   mean.percdev=mean(perc.dev),
                   mean.diffmeans=mean(diff.means),
                   mean.ratiomeans=mean(ratio.means))

trends.dates<-left_join(trav.africa.dates,trav.africa.month.trends,by="month")
trends.dates<-trends.dates[-which(duplicated(trends.dates$month)),]
trends.dates<-trends.dates[,-which(colnames(trends.dates) %in% c("year","monthyear","date"))]
trends.dates$month<-factor(trends.dates$month,levels=unique(trends.dates$month))
trend.dates.long<-pivot_longer(trends.dates,cols=2:4,names_to="comparison",values_to = "values") %>% as.data.frame()

col.comps<-c("aquamarine3","darkorange3")
names(col.comps)<-c("mean.diffmeans","mean.ratiomeans")

trend.dates.long %>%
  filter(comparison !="mean.percdev") %>%
  ggplot() +
  geom_bar(aes(y=values,x=month,fill=comparison),stat="identity")+
  facet_wrap(~comparison,scales="free")+
  pubTheme+
  labs(x=NULL,y="Value")+
  scale_fill_manual(values=col.comps)+
  theme(legend.position="none")

ggsave(paste0(fold.out,"Monthly trends in mean deviation_africa.png"),width=7,height=2,units="in")


trav.africa.all2<-left_join(trav.africa.all, trav.africa.month.trends, by="month")
#apply the perc deviaiton to multiply by the mean
trav.africa.all2<-trav.africa.all2 %>% mutate(
  expected.percdev=(mean.percdev * mean.trav.yr)+mean.trav.yr,
  expected.diffmeans=mean.trav.yr + mean.diffmeans,
  expected.ratiomeans=mean.trav.yr * mean.ratiomeans)

#resstructre the data frame to be long and only loook at monthly mean travellers
trav.africa.all3<-trav.africa.all2[,match(c("date",  "expected.percdev", "expected.diffmeans",
                                          "expected.ratiomeans", "mean.trav"),colnames(trav.africa.all2))]
trav.africa.all3.long<-trav.africa.all3 %>% pivot_longer(cols=2:5,names_to="calc",values_to="value")

#okayyy now have a looky across all metrics and entire time frame
cols.calc<-c(col.comps,regcol)
names(cols.calc)<-c("expected.diffmeans","expected.ratiomeans","mean.trav")
y.lim3<-c(0,550)
trav.africa.all3.long %>%
  filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+

  #EXTRA RECTS
  annotate(geom="rect",xmin = as.Date(int.start-365), xmax = as.Date(int.end-365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-2*365), xmax = as.Date(int.end-2*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start-3*365), xmax = as.Date(int.end-3*365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="rect",xmin = as.Date(int.start+365), xmax = as.Date(int.end+365),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.3,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDateYr+
  pubTheme+
  labs(y="Mean daily travellers from Africa", x=NULL)+
  scale_fill_manual(values=cols.calc)
ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from Africa_all.png"),
       width=7,height=3,units="in")

#zoom in on 2021 only
y.lim3<-c(-1,400)
trav.africa.all3.long %>%
  filter(date>as.Date("2021-06-01") & date<as.Date("2022-02-26")) %>%
    filter(calc != "expected.percdev") %>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim3[1], ymax =y.lim3[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim3[2], vjust=1, hjust=0.6,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
  scale_y_continuous(expand=expansion(c(0.01,0)),limits=y.lim3)+
  scaleDate+
  pubTheme+
  theme(legend.position = "top")+
  labs(y="Mean daily travellers from Africa", x=NULL)+
  guides(fill= guide_legend(nrow=2, title="Calculation"))+
  scale_fill_manual(values=cols.calc)

ggsave(paste0(fold.out,"Expected vs observed Mean daily trav from Africa_2021.png"),
       width=4,height=3,units="in")

```

## Apply global travel adjustment factor to travel expectations
```{r}
#join the adjust.factors on to the expected Africa travel data
# head(trav.africa.all3)
colnames(trav.africa.all3)[5]<-"Observed (ban)"
colnames(trav.africa.all3)[4]<-"Expected 1 (no ban)"

trav.all4.red<-trav.all4[,which(colnames(trav.all4) %in% c("date","adjust.factor"))]

trav.africa.all4<-left_join(trav.africa.all3, trav.all4.red, by="date")
# head(trav.africa.all4)

#apply the adjustment factor
trav.africa.all4<- trav.africa.all4 %>% 
  mutate(expected2 = `Expected 1 (no ban)`/adjust.factor)

#plot the two expected together

colnames(trav.africa.all4)[7]<-"Expected, adjusted (no ban)"  
trav.africa.all4.long<-trav.africa.all4 %>% 
  pivot_longer(cols=2:7,names_to="calc",values_to="value")

cols.calc3<-c("darkorange3","darkcyan",regcol)
names(cols.calc3)<-c("Expected 1 (no ban)", "Expected, adjusted (no ban)", "Observed (ban)")

y.lim<-c(0,270)
trav.africa.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected 1 (no ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2021-06-30") & date<as.Date("2022-02-26")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=0.6,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from Africa", x=NULL)+
    guides(fill= guide_legend(nrow=2, title="Calculation"))+
  scale_fill_manual(values=cols.calc3)

ggsave(paste0(fold.out,"Adjusted expectation mean daily Africa trav_2021.png"),
         width=4,height=3,units="in")

cols.calc4<-cols.calc3[c(2,3)]
trav.africa.all4.long %>%
  filter(calc %in% c("Observed (ban)","Expected, adjusted (no ban)")) %>%
  filter(date>as.Date("2020-10-31") & date<as.Date("2022-01-30")) %>%
  ggplot()+
   annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim[2], vjust=1, hjust=-.7,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
    geom_bar(aes(x=date, y=value,group=calc,fill=calc),stat="identity",position="dodge")+
    scale_y_continuous(expand=expansion(c(0.01,0)))+
    scaleDate+
    pubTheme+
    theme(legend.position = "top")+
    labs(y="Mean daily travellers from Africa", x=NULL)+
    guides(fill= guide_legend(nrow=1, title="Calculation"))+
  scale_fill_manual(values=cols.calc4)

ggsave(paste0(fold.out,"Adjusted expectation only mean daily Africa trav_2021.png"),
         width=4,height=3,units="in")

```
## convert monthly to rolling daily expected travel 
```{r}
#first, check the daily observed travel from africa
trav.africa.daily<-trav.africa[,which(colnames(trav.africa) %in% 
                                      c("REF_DATE","VALUE",
                                        "year","monthyear","month","date"))]

colnames(trav.africa.daily)[2]<-"Observed"

#now, leftjoin the monthyl expected data by "date" (actually month with 01)
trav.africa.all.red<-trav.africa.all4 %>% select (c("date","Expected, adjusted (no ban)",
                                                  "Observed (ban)"))
trav.africa.oe<-left_join(trav.africa.daily,trav.africa.all.red,by="date")

#rearrange and clean
trav.africa.oe<-trav.africa.oe[,c(1,3,4,5,2,7,8)]
head(trav.africa.oe)
colnames(trav.africa.oe)[c(6,7)]<-c("MonthlyAve_exp","MonthlyAve_obs")


## add a spline fit with daily predictions to this
pred.val.df<-trav.africa.oe
pred.val.df$decdate<-decimal_date(pred.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
pred.val.df$MonthlyAve_exp[str_which(pred.val.df$REF_DATE, "15",negate = T)]<-NA
pred.vals<-spline(x=pred.val.df$decdate, y=pred.val.df$MonthlyAve_exp,
                  xout=pred.val.df$decdate)
length(pred.vals$y)==nrow(pred.val.df)

#join these
pred.vals.df2<-pred.vals %>% as.data.frame()
colnames(pred.vals.df2)<-c("decdate","Expected (no ban)")
pred.vals.all<-left_join(pred.val.df,pred.vals.df2,by="decdate")
pred.vals.all.red<-pred.vals.all %>% select(c(`REF_DATE`,`Expected (no ban)`))
#now join back to obs vs expceted
trav.africa.oe2<-left_join(trav.africa.oe, pred.vals.all.red, by="REF_DATE")

trav.africa.oe2.long<-trav.africa.oe2 %>% pivot_longer(cols=5:8,names_to = "name",
                                                   values_to="value")
y.lim2<-c(0,270)
trav.africa.oe2.long %>%
  filter(REF_DATE >= as.Date("2021-06-30")) %>%
  filter(REF_DATE < as.Date("2022-02-26")) %>%
  filter(name %in% c("Expected (no ban)","MonthlyAve_exp"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.6,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,linetype=name),color="darkcyan")+
  labs(y="Daily travellers from Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  coord_cartesian(ylim=c(0,270))+
    theme(legend.position = c(0.01,0.9),legend.justification = c(0,1))
ggsave(paste0(fold.out,"Daily vs average expected from Africa_2021.png"),width=4,height=3,units="in")

y.lim2<-c(0,410)
trav.africa.oe2.long %>%
  filter(REF_DATE >= as.Date("2021-06-30")) %>%
  filter(REF_DATE < as.Date("2022-02-26")) %>%
  filter(name %in% c("Expected (no ban)","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.6,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  guides(color=guide_legend(title="Type"))+
  scale_color_manual(values=c("darkcyan",regcol))+
  theme(legend.position = c(0.01,0.9),legend.justification = c(0,1))
ggsave(paste0(fold.out,"Daily expected vs observed from Africa_2021.png"),width=4,height=3,units="in")

#Make a smoother version of the observed data
predobs.val.df<-trav.africa.oe
predobs.val.df$decdate<-decimal_date(predobs.val.df$REF_DATE)
#empty the values on any but the 15th day of the month
predobs.val.df$MonthlyAve_obs[str_which(predobs.val.df$REF_DATE, "15",negate = T)]<-NA
predobs.vals<-spline(x=predobs.val.df$decdate, y=predobs.val.df$MonthlyAve_obs,
                  xout=predobs.val.df$decdate)
length(predobs.vals$y)==nrow(predobs.val.df)

#join these
predobs.vals.df2<-predobs.vals %>% as.data.frame()
colnames(predobs.vals.df2)<-c("decdate","Observed, smooth (ban)")
predobs.vals.all<-left_join(predobs.val.df,predobs.vals.df2,by="decdate")
predobs.vals.all.red<-predobs.vals.all %>% select(c(`REF_DATE`,`Observed, smooth (ban)`))
#now join back to obs vs expceted
trav.africa.oe3<-left_join(trav.africa.oe2, predobs.vals.all.red, by="REF_DATE")

trav.africa.oe3.long<-trav.africa.oe3 %>% pivot_longer(cols=5:9,names_to = "name",
                                                   values_to="value")

trav.africa.oe3.long %>%
  filter(REF_DATE >= as.Date("2020-10-31")) %>%
  filter(REF_DATE < as.Date("2022-01-30")) %>%
  filter(name %in% c("Observed, smooth (ban)","MonthlyAve_obs","Observed"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.7,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate
ggsave(paste0(fold.out,"Daily smooth,daily, vs average observed from Africa_2021.png"),width=4,height=3,units="in")

#okay now a final plot of observed smooth and expected daily travellers
y.lim2<-c(0,420)
trav.africa.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-06-30")) %>%
  filter(REF_DATE < as.Date("2022-02-26")) %>%
  filter(name %in% c("Observed, smooth (ban)","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start),y=y.lim2[2], vjust=1, hjust=0.6,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=c(0,420))+
    theme(legend.position = c(0.01,0.9),legend.justification = c(0,1))


ggsave(paste0(fold.out,"Daily observed smooth vs expected from Africa_2021.png"),width=4,height=3,units="in")

#RAW

#okay now a final plot of observed RAW and expected daily travellers
y.lim2<-c(0,420)
p.supp.afr<-trav.africa.oe3.long %>%
  filter(REF_DATE >= as.Date("2021-10-01")) %>%
  filter(REF_DATE < as.Date("2022-01-31")) %>%
  filter(name %in% c("Observed","Expected (no ban)"))%>%
  ggplot()+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = as.Date(int.start)+14,y=y.lim2[2], vjust=1, hjust=0.6,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=REF_DATE,y=value,group=name,color=name))+
  labs(y="Daily travellers from Africa",x=NULL)+
  scale_y_continuous(expand=expansion(c(0.01,0)))+
  pubTheme+
  scaleDate+
  scale_color_manual(values=c("darkcyan",regcol))+
  guides(color=guide_legend(title="Calculation"))+
  coord_cartesian(ylim=y.lim2)+
    theme(legend.position =c(0.1,0.8),legend.justification = c(0,0.5))

p.supp.afr
ggsave(paste0(fold.out,"Daily observed raw vs expected from Africa_2021.png"),width=3,height=3,units="in")
```

## calculate the difference under the curves
```{r}
#area under expected, during ban
#sum the daily average from each day in the ban
total.expected<-trav.africa.oe3.long %>%
  filter(name %in% "Expected (no ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.expected #5417

#area under observed (smooth), during ban
total.observed.smooth<-trav.africa.oe3.long %>%
  filter(name %in% "Observed, smooth (ban)") %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.smooth #4563

#actual sum of observed, during ban
total.observed.actual<-trav.africa.oe3.long %>%
  filter(name %in%"Observed" ) %>%
  filter(REF_DATE >= int.start & REF_DATE <= int.end) %>%
  summarize(total=sum(value)) %>% as.integer()
total.observed.actual #3736

#difference
diff.actual<-total.expected - total.observed.actual
diff.smooth<-total.expected - total.observed.smooth
diff.actual; diff.smooth #1681, 854
```

## Export expected travel
```{r}
## Export expected and observed
write.csv(trav.africa.oe3, paste0(fold.out2,"trav.africa-omi.obs-exp.csv"))
```

## Make a single grob of all the variants except Delta observed raw vs expected
```{r}
plot_grid(p.supp.uk, p.supp.southafr, p.supp.braz, p.supp.afr, labels=LETTERS[1:4],nrow=1)
ggsave(paste0(fold.out,"FIGS21_allVars_ExpectedvsObserved.png"),width=11, height=3.2,units="in")
```

## Make a single grob of all the variants including Delta observed raw vs expected
```{r}
plot_grid(p.supp.uk, p.supp.southafr, p.supp.braz, p.supp.ind, p.supp.afr, labels=LETTERS[1:5],nrow=2)
ggsave(paste0(fold.out,"FIGS21_allVarsDelta_ExpectedvsObserved.png"),width=8.5, height=6.2,units="in")
```
