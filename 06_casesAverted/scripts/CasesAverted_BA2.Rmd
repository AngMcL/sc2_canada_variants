---
title: "Cases Averted"
author: "Angela"
date: '2023-05-24'
output: html_document
---

# Objectives
* Split off the cases averted from the 03_ancestral project and script
* repeat lm analysis
* compare to other fits
* with and without adjustment for travel volume
* compute relationsihp between travellers averted and intros/cases averted
* add a non-zero probability that a singleton is actually a sublineage: 5%-20% draw from the distribution of sublin sizes
* 

# Setup
```{r include=FALSE}
library(tidyverse)
library(RColorBrewer)
library(ggimage)
library(phytools)
library(phangorn)
library(forcats)
library(lubridate)
library(gridExtra)
library(cowplot)
library(MASS)
library(gtools)
library(treeio)
library(magick)
library(zoo)
library(fitdistrplus)

```

## Set inputs 
```{r}
#Modifiable inputs
focal.var<-"BA2"
Focal.var<-"BA.2" #str_to_title(focal.var)
ft_in<-paste0("../03_ancestral/2022_BA_ace_out/",focal.var,"_ace_out")
focal.source<-c("South Africa","Africa")
focal.source.brf<-c("Southern Africa")
int.yn<-TRUE
int.start<-as.Date("2021-11-26")
int.end<-as.Date("2021-12-18")
int.duration<-int.end-int.start
int.descrip<-"Southern Africa entry ban"
#periods to split up during ban
per1<-as.Date(c(int.start, int.start+(int.duration/2)))
per2<-as.Date(c(int.start+(int.duration/2)+1, int.end))

#for figures
fig.start.date<-as.Date("2021-11-01")
fig.end.date<-as.Date("2022-03-22")

#geo colors and lookup (merged to conts for small contribs)
global.colors.in<-"../01_subSample/colors_out/global.colors.tsv"
lookup.geo.in<-"../01_subSample/colors_out/lookup.geo.csv"

#variant colors
variant.colors.in<-"../01_subSample/CleanMeta_PreSubsamp/variant_colors.tsv"

#updated these
variant.df.in.glob<-paste0("../01_subSample/archive/Results_PreSubsamp_omi/variant.firstglobdate.csv")
variant.df.in<-paste0("../01_subSample/archive/Results_PreSubsamp_omi/variant.df.can.csv")

#individual boots together
sum.in<-list.files(ft_in,pattern=".sublin.firstCanDate.csv",full.names = T)  %>% mixedsort()
sing.in<-list.files(ft_in,pattern="_singletons.csv",full.names = T) %>% mixedsort()

#sublineages over time summarized across boots
sum.par.in<-paste0("../03_ancestral/2023-02-13_",focal.var,"_analysis/sum.par.roll.summary.csv")
sing.par.in<-paste0("../03_ancestral/2023-02-13_",focal.var,"_analysis/sing.par.roll.summary.csv")

# focal variant cases in
meta.glob.var.country.in<-"../01_subSample/Results_PreSubsamp_omi_2023/meta.glob.var.country.daily.full3.csv"
meta.can.var.country.in<-"../01_subSample/Results_PreSubsamp_omi_2023/meta.can.var.daily.full3.csv"

# travel data in
trav.in<-paste0("../07_StatCan_TravelData/Results_202305/ExpectedTravelVolume_Final_202305/trav.africa-omi",".obs-exp.csv")

# study period
data.date<-"2022-03-22" 
start.date<-"2020-11-01"

#boots  to operate over
n.B<-length(sum.in)
BOOTS<-1:n.B
print(paste("There are ",n.B," boots",sep=""))

# folder for exports
today<-Sys.Date()
f.out<-paste0(today,"_",focal.var,"_analysis/") 
if(!dir.exists(f.out)){dir.create(f.out)}

# EXPORT a textfile of inputs, summaries, and data queries
text.out<-paste0(f.out,today,"_",focal.var,"_DataSummary.txt")
cat(paste0("variant = ",focal.var),
    paste0("focal source geography = ",focal.source.brf),
    paste0("var-specific intervention = ",int.yn),
    file=text.out,sep="\n",append=F)

if(int.yn==T){
  cat(paste0("var-spec intervention: ",int.descrip, ", from ",int.start," - ", int.end),
      paste0("Intervention duration=",int.end-int.start),
      file=text.out,sep="\n",append=T)
}


#add to summary file
cat(paste0("n.boots = ",n.B),
    paste0("folder.out = ",f.out),file=text.out,sep="\n",append=TRUE)

```

## read in color for Global and lineage groups
```{r}
#import a tsv of name and hex color for LOCATIONS
globalPalette<-read.table(global.colors.in)

## make color scheme
glob.colz<-row.names(globalPalette) #NOTE THIS DIDN"T WORK
globalPalette.ch<-as.character(globalPalette$globalPalette)
names(globalPalette.ch)<-glob.colz

GlobColScale<-scale_colour_manual(name = "Location",values = globalPalette.ch,na.value="grey60")
GlobFillScale<-scale_fill_manual(name = "Location",values = globalPalette.ch,na.value="grey60")

CountryColScale<-scale_colour_manual(name = "Global region",
                                     values = globalPalette.ch[15:length( globalPalette.ch)],
                                     na.value="grey60")
CountryFillScale<-scale_fill_manual(name = "Global region",
                                    values = globalPalette.ch[15:length( globalPalette.ch)]
                                    ,na.value="grey60")

#read in lookup table to reduce cateogires to apply this color scheme (if haven't run MakeGlobalColors_boots.Rmd in this project already)
lookup.geo<-read.csv(lookup.geo.in)

## read in the variant df to use for inputs
var.df<-read.csv(variant.df.in)

#take the first canada data from this instead (complete for delta)
var.df.glob<-read.csv(variant.df.in.glob)
var.df.glob<-var.df.glob[,c("var.WHO","first.can.date")]
colnames(var.df.glob)<-c("var.WHO","first.can.date.new")
var.df<-left_join(var.df,var.df.glob,by="var.WHO")
var.df$first.can.date<-var.df$first.can.date.new #replaced!

var.df<-var.df[with(var.df, order(var.df$first.can.date, decreasing = F)),]

# use the first canadian sample date for variant to pull the delay in intervention from first canadian sample to int start
if(int.yn==T){
  firstsamp<-var.df$first.can.date[which(var.df$var.WHO %in% Focal.var)]
  cat(paste0("First Can sample: ", as.Date(firstsamp) ),
      paste0("Intervention delay = ", (int.start - as.Date(firstsamp)) ),
      file=text.out,sep="\n",append=T)
}

var.ord<-var.df$var.WHO
var.ord<-var.ord[-which(var.ord %in% c("Theta","Lambda","GH/490R"))]

varPalette<-read.table(variant.colors.in,sep="\t")

#varaint specific colors
focal.col<-rownames(varPalette)[which(tolower(varPalette$vars.ch)==Focal.var)]
focal.pango<-var.df$var.lin[var.df$var.WHO==Focal.var]
focal.pango<-str_replace_all(focal.pango,"\\+","\\|")
focal.pango<-str_replace_all(focal.pango,"\\*","")

## make color scheme
var.colz<-as.character(varPalette$vars.ch)
varPalette.ch<-row.names(varPalette)
names(varPalette.ch)<-var.colz

VOCColScale<-scale_colour_manual(name = "Variant",values = varPalette.ch,na.value=NULL)
VOCFillScale<-scale_fill_manual(name = "Variant",values = varPalette.ch,na.value=NULL)

VOCFillScale2<-scale_fill_manual(name = "Variant",values = varPalette.ch[match(var.ord,names(varPalette.ch))],na.value="grey60")
VOCColScale2<-scale_colour_manual(name = "Variant",values = varPalette.ch[match(var.ord,names(varPalette.ch))],na.value="grey60")

### FOR SEPEARATE OMI###
### add separate groups for each omicron group
omis<-c("BA.1","BA.1.1","BA.2")
# https://www.colorhexa.com/ec9a91
omiPalette.ch<-c("#e47266","#e8867b","#f0aea7") 
names(omiPalette.ch)<-omis
# morevarPal<-c(varPalette.ch,omiPalette.ch)
# morevarPal<-morevarPal[-which(names(morevarPal)=="Omicron")]

VarColScale<-scale_colour_manual(name = "Variant",values = omiPalette.ch,na.value=NULL)
VarFillScale<-scale_fill_manual(name = "Variant",values = omiPalette.ch,na.value=NULL)

var.col<-omiPalette.ch[which(names(omiPalette.ch)==Focal.var)]

```

## Figure publication themes
```{r}

pubTheme<-theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                panel.background=element_rect("grey95"), 
                axis.line = element_line(colour = "black"),
                legend.key.size = unit(0.5,"line"),
                text=element_text(size=10,face="bold"),
                legend.text=element_text(size=7))

pubThemeDate<-theme(panel.grid.major = element_blank(), 
                    panel.grid.minor = element_blank(),
                    panel.background=element_rect("grey95"), 
                    axis.line = element_line(colour = "black"),
                    text=element_text(size=10,face="bold"),
                    legend.key.size = unit(0.4,"line"),
                    legend.text=element_text(size=7),
                    axis.text.x=element_text(angle = 45,hjust=1,size=rel(1)))


scaleDate<-scale_x_date(date_breaks = "1 month", date_minor_breaks = "2 weeks", date_labels = "%b %Y",limits=as.Date(c(start.date,"2022-03-22")),expand=c(0,0))

xdates<-ymd(c("2020-12-01","2021-03-01","2021-06-01","2021-09-01","2021-12-01","2022-03-01"))
scaleDateBusy<-scale_x_date(breaks=xdates, date_labels = "%b %Y",
                            limits=as.Date(c(start.date,"2022-03-22")),
                            expand=c(0,0))

scaleDateFlex<-scale_x_date(date_labels = "%b %Y",expand=c(0,0))
scaleDateFlexLess<-scale_x_date(date_labels = "%b %Y",expand=c(0,0),
                                limits=c(fig.start.date,fig.end.date))


scaleMonthChar<-scale_x_discrete(breaks=c("2020-12","2021-03","2021-06","2021-09","2021-12","2022-03"),labels=c("Dec 2020","Mar 2021","Jun 2021","Sep 2021","Dec 2021","Mar 2022"))
```


## Size distributions for different periods / filters
```{r}
sum.boots<-replicate(vector,n=n.B) 
sum.boots[[1]]<-read.csv(sum.in[1])

## before restrictions
k=1 

#Bin sublineage size by frequency
sum.boots.binSize.pre<-sum.boots[[k]] %>% 
  filter(tmrca.dt<=int.end) %>%
  # filter(Parent.Location%in%focal.source) %>%
  group_by(N.Desc.glob,Lineage) %>% 
  dplyr::summarize(.groups="rowwise",n=n())

#Bin sublineage size by frequency, only for focal source
sum.boots.binSize.focalpre<-sum.boots[[k]] %>%
  filter(tmrca.dt<=int.end) %>%
  filter(Parent.Location%in%focal.source) %>%
  group_by(N.Desc.glob,Lineage) %>%
  dplyr::summarize(.groups="rowwise",n=n())

## Smooth curves of sublineage size 
## generate smooth density curves for sublineage size before end of restrictions
P3.smooth<-ggplot()+
  geom_density(data=sum.boots.binSize.pre,aes(x=N.Desc.glob),color="black",adjust = 10)+
  geom_density(data=sum.boots.binSize.focalpre,aes(x=N.Desc.glob),color="red",adjust = 10)+
  pubTheme+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.text.x=element_text(angle=45,vjust=1,hjust=1,size=rel(1.2)),
        # legend.position = c(0.7,0.8),
        legend.position = "none",
        legend.text = element_text(size=9),
        # axis.title.y=element_text(vjust=4),       
        axis.title.y=element_text(vjust=1,size=rel(1.2)), 
        plot.margin=unit(c(4,4,4,4),"pt"))+
  labs(x="Sublineage size",y="Density")+
  guides(fill=guide_legend(ncol= 1,title="Lineage",title.position="top",reverse = T, keywidth = 1.2,keyheight = 1.2))
  # scale_y_continuous(limits=c(0,71),expand=c(0.02,0))

P3.smooth
ggsave(paste(f.out,"/Sublineagesizes.Smooth.Frequencies.untilend.restric.png",sep=""),width=3,height=3,units="in")

```

## Estimate introductions averted during intervention using case data
```{r}
sum.Par.Roll.summary<-read.csv(sum.par.in)
sum.Par.Roll.summary$tmrca.dt<-as.Date(sum.Par.Roll.summary$tmrca.dt)

#sublin rate right before the intervetion:
sum.Par.Roll.focal.pre<-sum.Par.Roll.summary %>% 
  filter(Parent.Location%in%focal.source) %>%
  filter(tmrca.dt < int.start) #filtered to pre intervention

#full time period
sum.Par.Roll.focal<-sum.Par.Roll.summary %>% 
  filter(Parent.Location%in%focal.source) 

## read in this data on variant cases
meta.glob.var.country.daily.full3<-read.csv(meta.glob.var.country.in)

# not filtered to date
focal.var.cases<- meta.glob.var.country.daily.full3 %>% 
  filter(country%in%focal.source) %>%
  filter(var.WHO==Focal.var)
focal.var.cases$date<-as.Date(focal.var.cases$date)

#estimated total cases
sum(focal.var.cases$avgVOC_cases)# 1668184

#two geo cols
s.afr.col<-globalPalette.ch[which(names(globalPalette.ch)==focal.source[1])]
afr.col<-globalPalette.ch[which(names(globalPalette.ch)==focal.source[2])]

## Plot focal cases with overlay for flight ban
y.lim2<-c(0,(ceiling(max(focal.var.cases$avgVOC_cases))+2000))
p.focal.var.cases<-ggplot(focal.var.cases)+
    annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2]-50, color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x =( as.Date(int.start)+int.duration/1.3),
           y=y.lim2[2]-500, vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=date, y=avgVOC_cases,color=country),stat="identity",width=1)+
  pubThemeDate+
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y",
                            limits=c(fig.start.date, fig.end.date),
                            expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  GlobColScale+
  theme(legend.position = "none")+
  labs(x=NULL, y=paste0("Average daily ",Focal.var," cases in ",focal.source[2]))+
  #custom annot for diff locales
  annotate(geom="text",x =int.end,
           y=y.lim2[2]-7200, vjust=0.5, hjust=0.5,
           label=focal.source[1],size=2.5,
           color=s.afr.col)+
  annotate(geom="text",x =int.end+65,
           y=y.lim2[2]-2100, vjust=0.5, hjust=0.5,
           label=focal.source[2],size=2.5,
           color=afr.col)
  
p.focal.var.cases
ggsave(paste0(f.out,"p.focal.var.cases.png"),height=3,width=3,unit="in")

## join the focal cases to the uk importation rate pre intervention
sum.Par.Roll.focal$date<-sum.Par.Roll.focal$tmrca.dt
# class(focal.var.cases$tmrca.dt)
#this is limited to pre intervention...not anymore
focal.cases.intros<-left_join(sum.Par.Roll.focal, focal.var.cases, by="date")

#PLOT sublineages over time
y.lim2<-c(0,3)
p.sublin<-ggplot(focal.cases.intros)+
    annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x =( as.Date(int.start)+int.duration/1.5),
           y=y.lim2[2], vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=date, y=intros_meansum7d.mean,color=country),stat="identity",width=1)+
  geom_ribbon(aes(x=date,ymin = lower.CI,ymax = upper.CI,fill=country),alpha=0.3)+
  pubThemeDate+
  scale_x_date(breaks=xdates, date_labels = "%b %Y",
                            limits=c(fig.start.date, fig.end.date),
                            expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  GlobColScale+
  GlobFillScale+
  theme(legend.position = "none")+
  labs(x=NULL, y=paste0(Focal.var, " sublin./wk. from ",focal.source.brf))
  
p.sublin
ggsave(paste0(f.out,"p.sublin.overtime.png"),height=3,width=3,unit="in")

## Read in the expected and observed travel per day from stats can analysis
trav.vol<-read.csv(trav.in)

trav.vol.red<-trav.vol[,which(colnames(trav.vol) 
                                          %in% c("REF_DATE", "Observed",
                                                 "Expected..no.ban.",
                                                 "Observed..smooth..ban."))]
colnames(trav.vol.red)<-c("tmrca.dt","Observed.travel","Expected.travel","Observed.travel.smooth")
trav.vol.red$tmrca.dt<-as.Date(trav.vol.red$tmrca.dt)

#now join this travel data onto
focal.cases.intros.trav<-left_join(trav.vol.red,focal.cases.intros,by="tmrca.dt")

## make a mutated variable of travellers averted
focal.cases.intros.trav <-focal.cases.intros.trav %>% mutate("trav.averted"=Expected.travel - Observed.travel)
trav.vol.red$tmrca.dt<-as.Date(trav.vol.red$tmrca.dt)

focal.cases.intros.trav$country<-focal.source[1]
focal.cases.intros.trav$date<-focal.cases.intros.trav$tmrca.dt
y.lim2<-c(0,420)
p.var.travel<-ggplot(focal.cases.intros.trav)+
    annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x =( as.Date(int.start)+int.duration/1.5),
           y=y.lim2[2], vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=date, y=Observed.travel,color=country),stat="identity",width=1)+
  pubThemeDate+
  scale_x_date(date_break="1 month", date_labels = "%b %Y",
                            limits=c(fig.start.date, fig.end.date),
                            expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  GlobColScale+
  theme(legend.position = "none")+
  labs(x=NULL, y=paste0("Travellers per day from ",focal.source))+
  coord_cartesian(y=y.lim2)
  
p.var.travel
ggsave(paste0(f.out,"p.observedtravel.png"),height=3,width=3,unit="in")

#obserevd and expected trael in  one plot
#changed bc sublin are empty
focal.cases.intros.trav.long<-focal.cases.intros.trav %>% pivot_longer(cols = 2:3,#20:21, 
                                                                       values_to = "Travel volume",
                                                                       names_to = "Calculation")
#expected observerd cols, where observed is the variant color and expected is in dark grey
exp.obs.cols<-c(var.col,"black")
names(exp.obs.cols)<-c("Observed.travel","Expected.travel")
focal.cases.intros.trav.long$date<-focal.cases.intros.trav.long$tmrca.dt
y.lim2<-c(0,420)
p.var.travel2<-ggplot(focal.cases.intros.trav.long)+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x =( as.Date(int.start)+int.duration/1.5),
           y=y.lim2[2], vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  geom_line(aes(x=date, y=`Travel volume`,color=Calculation),stat="identity",width=1)+
  pubThemeDate+
  scale_x_date(breaks=xdates, date_labels = "%b %Y",
                            limits=c(fig.start.date, fig.end.date),
                            expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  scale_color_manual(values=exp.obs.cols)+  
  theme(legend.position = c(0.5,0.7), 
        legend.justification = c(0,0.5))+
  labs(x=NULL, y=paste0("Travellers per day from ",focal.source[1]))+
  coord_cartesian(y=y.lim2)
  
p.var.travel2
ggsave(paste0(f.out,"p.observed-expected-travel.png"),height=3,width=3,unit="in")


#make grob of all 
plot_grid(p.focal.var.cases, p.var.travel2, p.sublin, labels=LETTERS[1:3], nrow=1)
ggsave(paste0(f.out, "varcases-travel-sublin-time.png"), height=4,width=9,units="in")
```

## build models of observed sublin over time (Y) vs variant cases in focal var (X), adjusted for travel vol
#THERE ARE NO BA.2 sublins from South Africa!
```{r}
#subset to pre intervention
focal.cases.intros.trav.pre<-focal.cases.intros.trav %>%
  filter(date < int.start)
#subset to S africa
focal.cases.intros.trav.pre<-focal.cases.intros.trav.pre[which(focal.cases.intros.trav.pre$country==focal.source[1]),]

#remove instances of zero
rem<-which(focal.cases.intros.trav.pre$avgVOC_cases==0)
if(length(rem)>0){
  focal.cases.intros.trav.pre<-focal.cases.intros.trav.pre[-rem,]
}

#subset the data to when cases are >5000 in UK
focal.cases.intros.trav.pre.res<-focal.cases.intros.trav.pre %>% filter(avgVOC_cases>1)

# relationship between variables
ggplot(focal.cases.intros.trav.pre)+
  geom_point(aes(x=(avgVOC_cases), y=intros_meansum7d.mean))
ggplot(focal.cases.intros.trav.pre)+
  geom_point(aes(x=Observed.travel, y=intros_meansum7d.mean))
#weak
cor(focal.cases.intros.trav.pre$Observed.travel, focal.cases.intros.trav.pre$intros_meansum7d.mean)
#strong
cor(focal.cases.intros.trav.pre$avgVOC_cases, focal.cases.intros.trav.pre$intros_meansum7d.mean)
#less strong for restricted data... hmm, but captures the later data better...
cor(focal.cases.intros.trav.pre.res$avgVOC_cases, focal.cases.intros.trav.pre.res$intros_meansum7d.mean)

## LINEAR MODELS
#change to restricted (local) data
lm.cases.intros<-lm(data=focal.cases.intros.trav.pre.res, intros_meansum7d.mean ~ (avgVOC_cases))
sum.lm.cases.intros<-summary(lm.cases.intros) #Adjusted R-squared:  0.9531 ,  p-value: < 2.2e-16
#note adjusted R-sq is better for the linear avgVOC_cases than log()
sum.lm.cases.intros
adjustedr2<-round(sum.lm.cases.intros$r.squared,digits = 3)
text.adjustedr2<-paste0("Adj. R-squared = ",adjustedr2)

#Plot Relationship b/w cases and intros
p.focal.cases.intros<-ggplot(focal.cases.intros.trav.pre,
                             aes(x=(avgVOC_cases),
                                 y=intros_meansum7d.mean,color=country))+
  geom_point()+
  GlobColScale+
  theme(legend.position = "none")+
  labs(x=paste0("Average daily ",Focal.var," cases in ",focal.source[1]), 
       y=paste0(Focal.var," sublin./wk. from ",focal.source[1]))+
  geom_smooth(data=focal.cases.intros.trav.pre.res, method ="lm",se=T,level=0.95)+
  pubTheme+
  annotate(geom="label",
           x=1,y=max(focal.cases.intros$intros_meansum7d.mean,na.rm=T),
           label=text.adjustedr2,hjust=0)

p.focal.cases.intros
ggsave(paste0(f.out,"p.lm.focalvarcases.intros.png"),height=3,width=3,unit="in")
```

## compare to other models
```{r}
#how well do sublineages per week fit to travel vol
lm.cases.intros.trav<-lm(data=focal.cases.intros.trav.pre.res, 
                         intros_meansum7d.mean ~(avgVOC_cases) + (Observed.travel))
summary(lm.cases.intros.trav) #all coef are signif and R2 0.8548
summary(lm.cases.intros) 
# anova(lm.cases.intros.trav, lm.cases.intros,test="LRT")
# BIC(lm.cases.intros.trav)
# BIC(lm.cases.intros)
# AIC(lm.cases.intros.trav)
# AIC(lm.cases.intros)
#does not supports the addition of travel volume as a predictor

#what about other types of fits?
#POISSON
# focal.cases.intros.trav.pre.int<-focal.cases.intros.trav.pre.res %>% mutate(intros_meansum7d.meanint= round(intros_meansum7d.mean,digits=0))
# pois.cases.intros<-glm(data=focal.cases.intros.trav.pre.int, intros_meansum7d.meanint ~ (avgVOC_cases), family = "poisson")
# summary(pois.cases.intros)
# AIC(lm.cases.intros) #better
# AIC(pois.cases.intros)
# pois.cases.intros.trav<-glm(data=focal.cases.intros.trav.pre.int, intros_meansum7d.meanint ~ (avgVOC_cases) +
#                               Observed.travel, family = "poisson")
# 
# anova(pois.cases.intros.trav, pois.cases.intros,test="LRT") #not signif better
# AIC(pois.cases.intros.trav)
# AIC(lm.cases.intros.trav) #better
# plot(pois.cases.intros)
```

## predict number of sublins per week up until int.end
```{r}
# focal.var.cases.trav<-left_join(focal.var.cases, trav.vol.red, by="date")
# class(trav.vol.red$date)
#dataframe subset to during the intervetnion
focal.cases.new<-focal.cases.intros.trav%>% filter(date<=int.end & date>=int.start) 

#subset to S Africa
focal.cases.new<-focal.cases.new[which(focal.cases.new$country==focal.source[1]),]

focal.var.cases.trav.dur<-focal.cases.new[,c("avgVOC_cases","Expected.travel")] %>% as.data.frame()
head(focal.var.cases.trav.dur)
#change the colname back to observed so the model can use it to predict, 
#but these travel volumes are not observed, they are expected in the absence of ban
colnames(focal.var.cases.trav.dur)<-c("avgVOC_cases","Observed.travel")

# focal.var.cases.trav.dur$avgVOC_cases<-log(focal.var.cases.trav.dur$avgVOC_cases) #this is done

#now using both travel and variant cases to predict 
final.model<-lm.cases.intros
new.vals<-predict.lm(final.model, newdata = focal.var.cases.trav.dur,interval = "prediction")

#join new vals on with the new cases data
focal.var.cases.trav.dur2<-focal.var.cases.trav.dur %>% bind_cols(new.vals)
colnames(focal.var.cases.trav.dur2)[3:5]<-c("intros_meansum7d.mean","lower","upper")
focal.var.cases.trav.dur2$country<-focal.source[1]


#plot this to see how many sublins there might have been during the ban
p.obs.fit<-ggplot(focal.var.cases.trav.dur2,
       aes(x=Observed.travel,y=intros_meansum7d.mean,group=country)) +
    geom_ribbon(aes(ymin = lower,ymax = upper,fill=country),alpha=0.3)+
  geom_point(aes(color=country))+
  GlobColScale+
  GlobFillScale+
  theme(legend.position = "none")+
  labs(x="Average daily travel volume",
         # paste0("Average daily ",Focal.var," cases in ",focal.source), 
       y="Sublineages per week")

p.obs.fit

## Join this onto the other dataset, and distinguish them as 'no restriction' (predicted) and 'restrictions' (observed)
focal.cases.intros2<-focal.cases.intros.trav.pre.res[,c("avgVOC_cases","intros_meansum7d.mean","Observed.travel","country")]
focal.cases.intros2$type<-"Observed"

## Also need to add confidence intervals to the observed data that was fitted
focal.cases.intros2.new<-predict.lm(final.model, newdata = focal.cases.intros2,interval = "confidence")
#only want the upper and lower here
focal.cases.intros2.new<-focal.cases.intros2.new[,c(2,3)]
colnames(focal.cases.intros2.new)<-c("lower","upper")
focal.cases.intros3<-focal.cases.intros2 %>% bind_cols(focal.cases.intros2.new)

#join new vals on with the new cases data
focal.var.cases.trav.dur2<-focal.var.cases.trav.dur %>% bind_cols(new.vals)
colnames(focal.var.cases.trav.dur2)[3:5]<-c("intros_meansum7d.mean","lower","upper")
focal.var.cases.trav.dur2$country<-focal.source[1]
focal.var.cases.trav.dur2$type<-"Predicted"      
focal.obs.pred<-bind_rows(focal.cases.intros3,focal.var.cases.trav.dur2)

## colors for this
pred.pal<-exp.obs.cols
names(pred.pal)<-c("Observed","Predicted")

## Plot and color by type
p.focal.obs.pred<-ggplot(focal.obs.pred,
       aes(x=avgVOC_cases,y=intros_meansum7d.mean,group=type)) +
  # geom_ribbon(aes(ymin = lower,ymax = upper,fill=type),alpha=0.5)+
  geom_point(aes(color=type),alpha=0.5)+
  labs(x=paste0("Average daily ",Focal.var," cases in ", focal.source[1]), 
       y="Sublineages per week")+
  pubTheme+
  theme(legend.position = c(0.2,0.8))+
        # axis.title.x=element_text(margin = margin(t = -30)))+
  scale_fill_manual(values=pred.pal)+
  scale_color_manual(values=pred.pal)+
  guides(color=guide_legend(title="Scenario"),
         fill=guide_legend(title="Scenario"))+ 
    annotate(geom="label",
           x=1000,
           y=max(focal.obs.pred$intros_meansum7d.mean,na.rm=T),
           label=text.adjustedr2,hjust=0,size=3)

p.focal.obs.pred

## NOTE this is not as easily interpretd now if it includes two covariates
ggsave(paste0(f.out,"p.obs.pred.png"),height=3,width=3,unit="in")


#get dates back in here
focal.var.cases.trav.dur3<-focal.var.cases.trav.dur2 %>% left_join(focal.var.cases[,c("date","avgVOC_cases")],by="avgVOC_cases")
focal.var.cases.trav.dur3$type<-"Predicted"
# head(focal.var.cases.trav.dur3)

focal.intros.all<-sum.Par.Roll.summary %>% 
  filter(Parent.Location%in%focal.source[1])
focal.intros.all$type<-"Observed"
focal.intros.all$date<-focal.intros.all$tmrca.dt

colnames(focal.var.cases.trav.dur3)
focal.intros.all.red<-focal.intros.all[,]

### NOW plot this on the sublins per date
pred.pal2<-exp.obs.cols
names(pred.pal2)<-c("Observed","Predicted")
y.lim<-c(0,max(focal.var.cases.trav.dur3$intros_meansum7d.mean)+2)
p.focal.pred.sublin<-focal.intros.all %>%
  ggplot()+
  pubThemeDate+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  
           fill="grey80",alpha=0.9)+
  annotate(geom="text",x = (as.Date(int.start)+int.duration/1.5),
           y=y.lim[2]-0.2, vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  labs(x="Date of most recent common ancestor",y=paste0("Sublineages per week"))+
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y",
                            limits=c(fig.start.date, fig.end.date+7),
                            expand=c(0,0))+
  scale_y_continuous(expand=c(0,0))+
  #observed
   geom_density(aes(x=date,y=intros_meansum7d.mean,color=type),
               stat="identity",size=1.2,alpha=0.7)+
    geom_ribbon(aes(x=date,ymin=lower.CI,ymax=upper.CI,fill=type),
               stat="identity",alpha=0.5)+
  #predicted
  geom_density(data=focal.var.cases.trav.dur3,aes(x=date,y=intros_meansum7d.mean,
                                        color=type),
               stat="identity",size=1.2,alpha=0.7)+
  geom_ribbon(data=focal.var.cases.trav.dur3,aes(x=date,ymin=lower, ymax=upper,
                                        fill=type), stat="identity",alpha=0.5)+
  
  guides(color=guide_legend(title="Scenario"),
         fill=guide_legend(title="Scenario"))+
theme(legend.position = c(0.9,0.4),
        legend.justification = c(1,0),
        legend.text=element_text(size=rel(1.1)),
        legend.title=element_text(size=rel(1.1)))+  
  scale_color_manual(values=pred.pal2)+
  scale_fill_manual(values=pred.pal2)+
  coord_cartesian(y=y.lim)
p.focal.pred.sublin
ggsave(paste0(f.out,"p.focal.pred.sublin.png"),height=3,width=3,unit="in")

#no legend version
p.focal.pred.sublin.noleg<-p.focal.pred.sublin+
  theme(legend.position = "none")
p.focal.pred.sublin.noleg
ggsave(paste0(f.out,"p.focal.pred.sublin.no.leg.png"),height=3,width=3,unit="in")

```

## Calculate the difference in the area under curves for sublins
```{r}
#integrate stepwise daily 
observed.df<-focal.intros.all %>% filter(date<=int.end & date>=int.start) %>% dplyr::select (c("date","intros_meansum7d.mean"))
id<-order(observed.df$date)
AUC.observed<-sum(diff(observed.df$date[id])*
                  ((rollmean(observed.df$intros_meansum7d.mean[id],2))/7) ) %>% as.numeric()
#divided by seven to convert it to per day instead of per week
# AUC.observed #obser ved # of sublineages

### Predicted:
predicted.df<-focal.var.cases.trav.dur3 %>% filter(date<=int.end & date>=int.start) %>% dplyr::select (c("date","intros_meansum7d.mean"))
id<-order(predicted.df$date)
AUC.predicted<-sum(diff(predicted.df$date[id])*
                  ((rollmean(predicted.df$intros_meansum7d.mean[id],2))/7) ) %>% as.numeric()
AUC.predicted #observed # of sublineages

#upper limit
predicted.df.upper<-focal.var.cases.trav.dur3 %>% filter(date<=int.end & date>=int.start) %>% 
  dplyr::select (c("date","upper"))
id.upper<-order(predicted.df.upper$date)
AUC.predicted.upper<-sum(diff(predicted.df.upper$date[id.upper])*
                  ((rollmean(predicted.df.upper$upper[id.upper],2))/7) ) %>% as.numeric()

#lower limit
predicted.df.lower<-focal.var.cases.trav.dur3 %>% filter(date<=int.end & date>=int.start) %>% dplyr::select (c("date","lower"))
id.lower<-order(predicted.df.lower$date)
AUC.predicted.lower<-sum(diff(predicted.df.lower$date[id.lower])*
                  ((rollmean(predicted.df.lower$lower[id.lower],2))/7) ) %>% as.numeric()

## differences
averted.sublin<-AUC.predicted - AUC.observed
averted.sublin.day<-averted.sublin/as.numeric(int.end-int.start)

averted.sublin.upper<-AUC.predicted.upper - AUC.observed
averted.sublin.upper.day<-averted.sublin.upper/as.numeric(int.end-int.start)

averted.sublin.lower<-AUC.predicted.lower - AUC.observed
averted.sublin.lower.day<-averted.sublin.lower/as.numeric(int.end-int.start)

#compose sentecnces for text output
predicted.sublin.95ci<-paste0("Sublin predicted: ", round(AUC.predicted,digits=1),
       " (",round(AUC.predicted.lower,digits=1),
       "-",round(AUC.predicted.upper,digits=1),")")
averted.sublin.95ci<-paste0("Sublin averted: ", round(averted.sublin,digits=1),
       " (",round(averted.sublin.lower,digits=1),
       "-",round(averted.sublin.upper,digits=1),")")
averted.sublin.day.95ci<-paste0("Sublin averted per day: ", round(averted.sublin.day,digits=1),
       " (",round(averted.sublin.lower.day,digits=1),
       "-",round(averted.sublin.upper.day,digits=1),")")
```

## Sublin averted in different periods
```{r}
#Period 1
#ID list also works for pred df
id.per1<-which(observed.df$date>=per1[1] & 
                 observed.df$date<=per1[2])
#observed
AUC.observed.per1<-sum(diff(observed.df$date[id.per1])*
                  ((rollmean(observed.df$intros_meansum7d.mean[id.per1],2))/7) ) %>% as.numeric()
#predicted
#Period 1
AUC.predicted.per1<-sum(diff(predicted.df$date[id.per1])*
                  ((rollmean(predicted.df$intros_meansum7d.mean[id.per1],2))/7) ) %>% as.numeric()
#upper and lowers:
AUC.predicted.per1.upper<-sum(diff(predicted.df.upper$date[id.per1])*
                  ((rollmean(predicted.df.upper$upper[id.per1],2))/7) ) %>% as.numeric()
AUC.predicted.per1.lower<-sum(diff(predicted.df.lower$date[id.per1])*
                  ((rollmean(predicted.df.lower$lower[id.per1],2))/7) ) %>% as.numeric()

## total averted sublin in period 1
averted.sublin.per1<-AUC.predicted.per1 - AUC.observed.per1
#averted sublin per day
averted.sublin.per1.day<-averted.sublin.per1/as.numeric(diff(per1)) 

## total averted sublin in period 1, upper
averted.sublin.per1.upper<-AUC.predicted.per1.upper - AUC.observed.per1
#averted sublin per day
averted.sublin.per1.upper.day<-averted.sublin.per1.upper/as.numeric(diff(per1)) 

## total averted sublin in period 1, lower
averted.sublin.per1.lower<-AUC.predicted.per1.lower - AUC.observed.per1
#averted sublin per day
averted.sublin.per1.lower.day<-averted.sublin.per1.lower/as.numeric(diff(per1)) 

### Period 2 ####
id.per2<-which(observed.df$date>=per2[1] & 
                 observed.df$date<=per2[2])
#observed
AUC.observed.per2<-sum(diff(observed.df$date[id.per2])*
                  ((rollmean(observed.df$intros_meansum7d.mean[id.per2],2))/7) ) %>% as.numeric()
#predicted
AUC.predicted.per2<-sum(diff(predicted.df$date[id.per2])*
                  ((rollmean(predicted.df$intros_meansum7d.mean[id.per2],2))/7) ) %>% as.numeric()

#upper and lowers:
AUC.predicted.per2.upper<-sum(diff(predicted.df.upper$date[id.per2])*
                  ((rollmean(predicted.df.upper$upper[id.per2],2))/7) ) %>% as.numeric()
AUC.predicted.per2.lower<-sum(diff(predicted.df.lower$date[id.per2])*
                  ((rollmean(predicted.df.lower$lower[id.per2],2))/7) ) %>% as.numeric()

## total averted sublin in period 1
averted.sublin.per2<-AUC.predicted.per2 - AUC.observed.per2
#averted sublin per day
averted.sublin.per2.day<-averted.sublin.per2/as.numeric(diff(per2)) 

## total averted sublin in period 1, upper
averted.sublin.per2.upper<-AUC.predicted.per2.upper - AUC.observed.per2
#averted sublin per day
averted.sublin.per2.upper.day<-averted.sublin.per2.upper/as.numeric(diff(per2)) 

## total averted sublin in period 1, lower
averted.sublin.per2.lower<-AUC.predicted.per2.lower - AUC.observed.per2
#averted sublin per day
averted.sublin.per2.lower.day<-averted.sublin.per2.lower/as.numeric(diff(per2)) 

#compare!
averted.sublin.per1 #130 tot
averted.sublin.per2 #65 tot
averted.sublin.per1.day #1.878089 per day
averted.sublin.per2.day #0.7516021 per day

#compose sentecnces for text output
averted.sublin.per1.95ci<-paste0("Sublin averted in period 1: ", round(averted.sublin.per1,digits=1),
       " (",round(averted.sublin.per1.lower,digits=1),
       "-",round(averted.sublin.per1.upper,digits=1),")")
averted.sublin.per1.day.95ci<-paste0("Sublin averted per day in period 1: ", 
                                     round(averted.sublin.per1.day,digits=1),
       " (",round(averted.sublin.per1.lower.day,digits=1),
       "-",round(averted.sublin.per1.upper.day,digits=1),")")

averted.sublin.per2.95ci<-paste0("Sublin averted in period 2: ", round(averted.sublin.per2,digits=1),
       " (",round(averted.sublin.per2.lower,digits=1),
       "-",round(averted.sublin.per2.upper,digits=1),")")
averted.sublin.per2.day.95ci<-paste0("Sublin averted per day in period 2: ", 
                                     round(averted.sublin.per2.day,digits=1),
       " (",round(averted.sublin.per2.lower.day,digits=1),
       "-",round(averted.sublin.per2.upper.day,digits=1),")")
```

## Add sublin averted to the data text export
```{r}
cat(paste0("Sublineages observed during restrictions: ",
           round(AUC.observed,digits = 1)),
  predicted.sublin.95ci,
   
   averted.sublin.95ci,
   averted.sublin.day.95ci,
   
   averted.sublin.per1.95ci,
   averted.sublin.per1.day.95ci,
   
   averted.sublin.per2.95ci,
   averted.sublin.per2.day.95ci,
   
   file=text.out, append=T,sep="\n")
```

## Calculate cases averted: sum of sublin sizes averted
```{r}
## fit a gamma model to the observed distribution of sublinaege sizes caluclate above (wayy up)
#https://www.geeksforgeeks.org/how-to-fit-a-gamma-distribution-to-a-dataset-in-r/?ref=rp
# Moment matching estimation consists in equalizing theoretical and empirical moments. Estimated values of the distribution parameters are computed by a closed-form formula
ans.pre <- fitdist(as.numeric(sum.boots.binSize.pre$N.Desc.glob), 
               distr = "gamma", method = "mme", #start=c(1,1000),
               discrete=T)

ans.focalpre <- fitdist(as.numeric(sum.boots.binSize.focalpre$N.Desc.glob), 
               distr = "gamma", method = "mme", #start=c(1,1000),
               discrete=T)

#Gamma fit parameters
# ans.focalpre$estimate[1] #shape
# ans.focalpre$estimate[2] #rate

## Setup a function to loop 1000 draws of N sublineages frm gamma distrib
draw.averted.cases<-function(N, gamma.df){
  cases.averted.all<-vector()
  for (i in 1:1000){
    set.seed(i) 
    # Draw N gamma distributed values
    y_rgamma <- rgamma(N, 
                     shape = gamma.df$estimate[1],
                     rate=gamma.df$estimate[2]) 
    y_rgamma<-ceiling(y_rgamma) #round up 
  
    # Plot of randomly drawn gamma density
    tots<-sum(y_rgamma) # total cases averted
    cases.averted.all<-c(cases.averted.all,tots)
  }  
  cases.averted.all.df<-cases.averted.all %>% as.data.frame()
  colnames(cases.averted.all.df)<-"cases.averted.all"
  return(cases.averted.all.df)
}

#run function to draw
cases.averted.all.df.pre<-draw.averted.cases(N=averted.sublin,
                                             gamma.df=ans.pre)

#function
mean.95ci.X<-function(vector, digits){
  n<-length(vector)
  m<-mean(vector)
  sd<-sd(vector)
  t<-qt(0.025,(n-1),lower.tail=F)
  up<-m+(sd/sqrt(n)*t)
  low<-m-(sd/sqrt(n)*t)
  return(paste(round(m,digits=digits), " (",round(low,digits=digits)," - ",round(up,digits=digits),")",sep=""))
}

#plot it
cases.averted.ci<-mean.95ci.X(cases.averted.all.df.pre$cases.averted.all)
mean<-mean(cases.averted.all.df.pre$cases.averted.all)  
ymax<-0.4

p.averted1.varcol<-ggplot(cases.averted.all.df.pre) +
  geom_density(aes(x=cases.averted.all,y=..count..),
               color=var.col,fill=var.col,alpha=0.5)+   
  labs(x=paste0(Focal.var, " cases averted"),y="Frequency")+
  geom_vline(xintercept = mean, linetype=2)+
  annotate(geom = "text",x =mean+100,y=ymax,
           label=paste0("Mean cases averted (95% CI)\n= ",cases.averted.ci),
           hjust=-0.05,size=3)+
  pubTheme
  # theme(axis.title.x=element_text(margin = margin(t = -30))) #run for grob only
p.averted1.varcol
ggsave(paste0(f.out,"cases.averted.allsourcesendrestric_varcol.png"),height=2.7,width=3,unit="in")

##repeat for focal only gamma distribution of sublin sizees
cases.averted.focal.df<-draw.averted.cases(N=averted.sublin,
                                           gamma.df = ans.focalpre)
#plot it
cases.averted.ci.focal<-mean.95ci.X(cases.averted.focal.df$cases.averted.all)
meanfocal<-mean(cases.averted.focal.df$cases.averted.all)  
ymax<-3
p.avert2<-ggplot(cases.averted.focal.df) +
  geom_density(aes(x=cases.averted.all,y=..count..),
               color="chartreuse3",fill="chartreuse3",alpha=0.5)+
  labs(x="Cases averted",y="Frequency")+
  geom_vline(xintercept = meanfocal, 
             color="darkblue",linetype=2)+
  annotate(geom = "text",x =mean,y=ymax,
           label=paste0("Mean cases averted (95% CI)\n= ",cases.averted.ci.focal),
           hjust=1)+
  pubTheme
p.avert2
ggsave(paste0(f.out,"cases.averted.focalsourcesendrestric.png"),height=3,width=4,unit="in")

## Repeat for lower and upper 95% ci of averted sublin
cases.averted.lower<-draw.averted.cases(N=averted.sublin.lower,
                                           gamma.df = ans.pre)
cases.averted.lower.ci<-mean.95ci.X(cases.averted.lower$cases.averted.all)
cases.averted.upper<-draw.averted.cases(N=averted.sublin.upper,
                                           gamma.df = ans.pre)
cases.averted.upper.ci<-mean.95ci.X(cases.averted.upper$cases.averted.all)

# cases.averted.ci
# cases.averted.lower.ci
# cases.averted.upper.ci
## repeat for per 1 and per2
```

## Grob together the key plots from this analysis
```{r}
plot_grid(p.focal.var.cases, p.focal.cases.intros, 
          p.focal.pred.sublin, p.averted1.varcol, nrow=2,labels=LETTERS[1:4],
          align="hv")
ggsave(paste0(f.out,"composite_casesAverted_full.png"),height=7,width=7,units = "in")

#horizontal version
plot_grid(p.focal.var.cases, p.focal.cases.intros, 
          p.focal.pred.sublin, p.averted1.varcol, nrow=1,labels=LETTERS[1:4],
          align="hv")
ggsave(paste0(f.out,"composite_casesAverted_full_h.png"),height=3.8,width=13,units = "in")

```

## Add cases from sublin averted to the data text export
```{r}
cat(paste0("Mean cases (sublin desc) averted, all source distrib, mean: ",
           cases.averted.ci),
      paste0("Mean cases (sublin desc) averted, all source,lower: ",
           cases.averted.lower.ci),
    paste0("Mean cases (sublin desc) averted, all source, upper: ",
           cases.averted.upper.ci),
    paste0("Mean cases (sublin desc) averted, focal distrib, mean: ",
           cases.averted.ci.focal),
    file=text.out, append=T,sep="\n")
```


# Singletons averted

## Estimate singletons averted during intervention using case data
```{r}
sing.Par.Roll.summary<-read.csv(sing.par.in)
sing.Par.Roll.summary$tmrca.dt.half<-as.Date(sing.Par.Roll.summary$tmrca.dt.half)
zer<-which(as.numeric(sing.Par.Roll.summary$intros_meansum7d.mean)==0)
if(length(zer)>0){
  sing.Par.Roll.summary<-sing.Par.Roll.summary[-zer,]
}

#singleton rate right before the intervention:
sing.Par.Roll.focal.pre<-sing.Par.Roll.summary %>% 
  filter(par.state%in%focal.source[1]) #%>% #only S A
  # filter(tmrca.dt.half < (int.start)) 

#limited data so don't look at only before

# table(sing.Par.Roll.summary$par.state)
# hist(sing.Par.Roll.summary$intros_meansum7d.mean[sing.Par.Roll.summary$par.state=="Africa"])
## join the focal cases to the importation rate pre intervention
sing.Par.Roll.focal.pre$date<-sing.Par.Roll.focal.pre$tmrca.dt.half
# class(focal.var.cases$tmrca.dt)
focal.cases.intros.sing<-left_join(sing.Par.Roll.focal.pre, focal.var.cases, by="date")
# head(focal.cases.intros.sing)

table(focal.cases.intros.sing$country)
focal.cases.intros.sing<-focal.cases.intros.sing[which(focal.cases.intros.sing$country==focal.source[1]),]
focal.cases.intros.sing.res<-focal.cases.intros.sing #%>% filter(avgVOC_cases>1)


#Make a linear model
#use this to predict the number of singletons averted based on cases
#RESTRICT TO LOCAL
lm.cases.intros.sing<-lm(data=focal.cases.intros.sing.res, intros_meansum7d.mean ~ avgVOC_cases)
sing.lm.cases.intros.sing<-summary(lm.cases.intros.sing) #Adjusted R-squared:  0.9531 ,  p-value: < 2.2e-16
sing.lm.cases.intros.sing
adjustedr2<-round(sing.lm.cases.intros.sing$r.squared,digits = 3)
text.adjustedr2<-paste0("Multiple R-squared = ",adjustedr2)
#Relationship b/w cases in the UK And intros into Canada
p.sing.focal.cases.intros.sing<-ggplot(focal.cases.intros.sing,
                             aes(x=avgVOC_cases,
                                 y=intros_meansum7d.mean,color=country))+
  geom_point()+
  GlobColScale+
  theme(legend.position = "none")+
  labs(x=paste0("Average daily ",Focal.var," cases in ",focal.source[1]), 
       y="Singletons per week")+
  geom_smooth(data=focal.cases.intros.sing.res, method ="lm",se=T,level=0.95)+
  pubTheme+
  annotate(geom="label",
           x=1,y=max(focal.cases.intros.sing$intros_meansum7d.mean,na.rm=T),
           label=text.adjustedr2,hjust=0)

p.sing.focal.cases.intros.sing
ggsave(paste0(f.out,"p.sing.focal.var.cases.intros.sing.lm.png"),height=3,width=3,unit="in")

#now predict number of singletons per week up until int.end
focal.cases.new<-focal.var.cases %>% filter(date<=int.end & date>=int.start) 
focal.cases.new<-focal.cases.new[which(focal.cases.new$country==focal.source[1]),]
focal.var.cases.trav.dur.sing<-focal.cases.new$avgVOC_cases %>% as.data.frame()
colnames(focal.var.cases.trav.dur.sing)<-"avgVOC_cases"
new.vals<-predict.lm(lm.cases.intros.sing,newdata = focal.var.cases.trav.dur.sing,interval = "prediction")
#join new vals on with the new cases data
focal.var.cases.trav.dur.sing2<-focal.var.cases.trav.dur.sing %>% bind_cols(new.vals)
colnames(focal.var.cases.trav.dur.sing2)[2:4]<-c("intros_meansum7d.mean","lower","upper")
focal.var.cases.trav.dur.sing2$country<-focal.source[1]

#plot this to see how many singletons there might have been during the ban
p.sing.obs.fit<-ggplot(focal.var.cases.trav.dur.sing2,
       aes(x=avgVOC_cases,y=intros_meansum7d.mean,group=country)) +
    geom_ribbon(aes(ymin = lower,ymax = upper,fill=country),alpha=0.3)+
  geom_point(aes(color=country))+
  GlobColScale+
  GlobFillScale+
  theme(legend.position = "none")+
  labs(x=paste0("Average daily ",Focal.var," cases in ",focal.source[1]), 
       y="Singletons per week")
p.sing.obs.fit
ggsave(paste0(f.out,"p.sing.obs.fit.png"),height=3,width=3,unit="in")

## Join this onto the other dataset, and distinguish them as 'no restriction' (predicted) and 'restrictions' (observed)

focal.cases.intros.sing2<-focal.cases.intros.sing[,c("avgVOC_cases","intros_meansum7d.mean","country")]
focal.cases.intros.sing2$type<-"Observed"
# table(focal.cases.intros.sing2$country)

## Also need to add confidence intervals to the observed data that was fitted
focal.cases.intros.sing2.new<-predict.lm(lm.cases.intros.sing,newdata = focal.cases.intros.sing2,interval = "prediction")
#only want the upper and lower here
focal.cases.intros.sing2.new<-focal.cases.intros.sing2.new[,c(2,3)]
colnames(focal.cases.intros.sing2.new)<-c("lower","upper")
focal.cases.intros.sing3<-focal.cases.intros.sing2 %>% bind_cols(focal.cases.intros.sing2.new)
# table(focal.cases.intros.sing3$country)

#join new vals on with the new cases data
focal.var.cases.trav.dur.sing2<-focal.var.cases.trav.dur.sing %>% bind_cols(new.vals)
colnames(focal.var.cases.trav.dur.sing2)[2:4]<-c("intros_meansum7d.mean","lower","upper")
focal.var.cases.trav.dur.sing2$country<-focal.source[1]
focal.var.cases.trav.dur.sing2$type<-"Predicted"      
focal.obs.pred<-bind_rows(focal.cases.intros.sing3,focal.var.cases.trav.dur.sing2)

## colors for this
pred.pal<-exp.obs.cols
names(pred.pal)<-c("Observed","Expected")
## Plot and color by type
p.sing.focal.obs.pred<-ggplot(focal.obs.pred,
       aes(x=avgVOC_cases,y=intros_meansum7d.mean,group=type)) +
  geom_ribbon(aes(ymin = lower,ymax = upper,fill=type),alpha=0.5)+
  geom_point(aes(color=type),alpha=0.8)+
  labs(x=paste0("Average daily ",Focal.var," cases in ",focal.source[1]), y="Singletons per week")+
  # geom_smooth(method ="lm",alpha=0.2,color=type)+
  pubTheme+
  theme(legend.position = c(0.2,0.7))+
        # axis.title.x=element_text(margin = margin(t = -30)))+
  scale_fill_manual(values=pred.pal)+
  scale_color_manual(values=pred.pal)+
  guides(color=guide_legend(title="Scenario"),
         fill=guide_legend(title="Scenario"))+ 
    annotate(geom="label",
           x=min(focal.obs.pred$avgVOC_cases,na.rm=T),
           y=max(focal.obs.pred$intros_meansum7d.mean+1,na.rm=T),
           label=text.adjustedr2,hjust=0,size=3)

p.sing.focal.obs.pred
ggsave(paste0(f.out,"p.sing.obs.pred.png"),height=3,width=3,unit="in")

## Join the predicted values onto the data over time

#get dates back in here
focal.var.cases.trav.dur.sing3<-focal.var.cases.trav.dur.sing2 %>% left_join(focal.var.cases[,c("date","avgVOC_cases")],by="avgVOC_cases")
focal.var.cases.trav.dur.sing3$type<-"Predicted"
# head(focal.var.cases.trav.dur.sing3)

focal.intros.sing.all<-sing.Par.Roll.summary %>% 
  filter(par.state%in%focal.source[1])
focal.intros.sing.all$type<-"Observed"
focal.intros.sing.all$date<-focal.intros.sing.all$tmrca.dt
# colnames(focal.var.cases.trav.dur.sing3)

### NOW plot this on the singletons per date
pred.pal2<-pred.pal
names(pred.pal2)<-c("Observed","Predicted")
y.lim<-c(0,max(focal.var.cases.trav.dur.sing3$intros_meansum7d.mean)+3)
p.sing.focal.pred.singleton<-focal.intros.sing.all %>%
  ggplot()+
  pubThemeDate+
  annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim[1], ymax =y.lim[2], color="grey85",size=0,  fill="grey80")+
  annotate(geom="text",x = (as.Date(int.start)+int.duration/2),y=y.lim[2]-0.2, vjust=1, hjust=0.5,
           label=int.descrip,fontface="italic",color="grey25",size=3)+
  labs(x="Date of most recent common ancestor",y=paste0("Singletons per week"))+
  scaleDateFlexLess+
  scale_y_continuous(expand=c(0,0))+
  #observed
   geom_line(aes(x=date,y=intros_meansum7d.mean,color=type),
               stat="identity",size=1.5,alpha=0.7)+
      geom_ribbon(aes(x=date,ymin=lower.CI,ymax=upper.CI,fill=type),
               stat="identity",alpha=0.5)+
  #predicted
  geom_line(data=focal.var.cases.trav.dur.sing3,aes(x=date,
                                                    y=intros_meansum7d.mean,
                                                    color=type),
               stat="identity",size=1.5,alpha=0.7)+
  
  geom_ribbon(data=focal.var.cases.trav.dur.sing3,aes(x=date,ymin=lower, ymax=upper,
                                        fill=type), stat="identity",alpha=0.5)+
  guides(color=guide_legend(title="Scenario"),
         fill=guide_legend(title="Scenario"))+
  theme(legend.position = c(0.6,0.8))+
  scale_color_manual(values=pred.pal2)+
  scale_fill_manual(values=pred.pal2)+
  coord_cartesian(y=y.lim)
p.sing.focal.pred.singleton
ggsave(paste0(f.out,"p.sing.focal.pred.singleton.png"),height=3.5,width=3.5,unit="in")

```

## Calculate the difference in the area under curves
```{r}
#integrate stepwise daily 
observed.df<-focal.intros.sing.all %>% filter(date<=int.end & date>=int.start) %>% dplyr::select (c("date","intros_meansum7d.mean"))
id<-order(observed.df$date)
AUC.observed.sing<-sum(diff(observed.df$date[id])*
                  ((rollmean(observed.df$intros_meansum7d.mean[id],2))/7) ) %>% as.numeric()
#divided by seven to convert it to per day instead of per week

### Predicted:
predicted.df<-focal.var.cases.trav.dur.sing3 %>% filter(date<=int.end & date>=int.start) %>% dplyr::select (c("date","intros_meansum7d.mean"))
id<-order(predicted.df$date)
AUC.predicted.sing<-sum(diff(predicted.df$date[id])*
                  ((rollmean(predicted.df$intros_meansum7d.mean[id],2))/7) ) %>% as.numeric()

#upper limit
predicted.df.upper<-focal.var.cases.trav.dur.sing3 %>% filter(date<=int.end & date>=int.start) %>% dplyr::select (c("date","upper"))
id.upper<-order(predicted.df$date)
AUC.predicted.sing.upper<-sum(diff(predicted.df.upper$date[id.upper])*
                  ((rollmean(predicted.df.upper$upper[id.upper],2))/7) ) %>% as.numeric()

#lower limit
predicted.df.lower<-focal.var.cases.trav.dur.sing3 %>% filter(date<=int.end & date>=int.start) %>% dplyr::select (c("date","lower"))
id.lower<-order(predicted.df$date)
AUC.predicted.sing.lower<-sum(diff(predicted.df.lower$date[id.lower])*
                  ((rollmean(predicted.df.lower$lower[id.lower],2))/7) ) %>% as.numeric()

## differences
averted.singleton<-AUC.predicted.sing - AUC.observed.sing
averted.singleton.day<-averted.singleton/as.numeric(int.end-int.start)

averted.singleton.upper<-AUC.predicted.sing.upper - AUC.observed.sing
averted.singleton.upper.day<-averted.singleton.upper/as.numeric(int.end-int.start)

averted.singleton.lower<-AUC.predicted.sing.lower - AUC.observed.sing
averted.singleton.lower.day<-averted.singleton.lower/as.numeric(int.end-int.start)

#compose sentecnces for text output
predicted.single.95ci<-paste0("singletons predicted: ", round(AUC.predicted.sing,digits=1),
       " (",round(AUC.predicted.sing.lower,digits=1),
       "-",round(AUC.predicted.sing.upper,digits=1),")")

averted.single.95ci<-paste0("Singletons averted: ",round(averted.singleton,digits=1),
       " (",round(averted.singleton.lower,digits=1),
       "-",round(averted.singleton.upper,digits=1),")")

averted.single.day.95ci<-paste0("Singletons averted per day: ", round(averted.singleton.day,digits=1),
       " (",round(averted.singleton.lower.day,digits=1),
       "-",round(averted.singleton.upper.day,digits=1),")")
```

## REPEAT this for the two periods

## singleton averted in different periods
```{r}
#Period 1
#ID list also works for pred df
id.per1<-which(observed.df$date>=per1[1] & 
                 observed.df$date<=per1[2])
#observed
AUC.observed.per1<-sum(diff(observed.df$date[id.per1])*
                  ((rollmean(observed.df$intros_meansum7d.mean[id.per1],2))/7) ) %>% as.numeric()
#predicted
#Period 1
AUC.predicted.per1<-sum(diff(predicted.df$date[id.per1])*
                  ((rollmean(predicted.df$intros_meansum7d.mean[id.per1],2))/7) ) %>% as.numeric()
#upper and lowers:
AUC.predicted.per1.upper<-sum(diff(predicted.df.upper$date[id.per1])*
                  ((rollmean(predicted.df.upper$upper[id.per1],2))/7) ) %>% as.numeric()
AUC.predicted.per1.lower<-sum(diff(predicted.df.lower$date[id.per1])*
                  ((rollmean(predicted.df.lower$lower[id.per1],2))/7) ) %>% as.numeric()

## total averted singleton in period 1
averted.singleton.per1<-AUC.predicted.per1 - AUC.observed.per1
#averted singleton per day
averted.singleton.per1.day<-averted.singleton.per1/as.numeric(diff(per1)) 

## total averted singleton in period 1, upper
averted.singleton.per1.upper<-AUC.predicted.per1.upper - AUC.observed.per1
#averted singleton per day
averted.singleton.per1.upper.day<-averted.singleton.per1.upper/as.numeric(diff(per1)) 

## total averted singleton in period 1, lower
averted.singleton.per1.lower<-AUC.predicted.per1.lower - AUC.observed.per1
#averted singleton per day
averted.singleton.per1.lower.day<-averted.singleton.per1.lower/as.numeric(diff(per1)) 

### Period 2 ####
id.per2<-which(observed.df$date>=per2[1] & 
                 observed.df$date<=per2[2])
#observed
AUC.observed.per2<-sum(diff(observed.df$date[id.per2])*
                  ((rollmean(observed.df$intros_meansum7d.mean[id.per2],2))/7) ) %>% as.numeric()
#predicted
AUC.predicted.per2<-sum(diff(predicted.df$date[id.per2])*
                  ((rollmean(predicted.df$intros_meansum7d.mean[id.per2],2))/7) ) %>% as.numeric()

#upper and lowers:
AUC.predicted.per2.upper<-sum(diff(predicted.df.upper$date[id.per2])*
                  ((rollmean(predicted.df.upper$upper[id.per2],2))/7) ) %>% as.numeric()
AUC.predicted.per2.lower<-sum(diff(predicted.df.lower$date[id.per2])*
                  ((rollmean(predicted.df.lower$lower[id.per2],2))/7) ) %>% as.numeric()

## total averted singleton in period 1
averted.singleton.per2<-AUC.predicted.per2 - AUC.observed.per2
#averted singleton per day
averted.singleton.per2.day<-averted.singleton.per2/as.numeric(diff(per2)) 

## total averted singleton in period 1, upper
averted.singleton.per2.upper<-AUC.predicted.per2.upper - AUC.observed.per2
#averted singleton per day
averted.singleton.per2.upper.day<-averted.singleton.per2.upper/as.numeric(diff(per2)) 

## total averted singleton in period 1, lower
averted.singleton.per2.lower<-AUC.predicted.per2.lower - AUC.observed.per2
#averted singleton per day
averted.singleton.per2.lower.day<-averted.singleton.per2.lower/as.numeric(diff(per2)) 

#compare!
averted.singleton.per1 #130 tot
averted.singleton.per2 #65 tot
averted.singleton.per1.day #1.878089 per day
averted.singleton.per2.day #0.7516021 per day

#compose sentecnces for text output
averted.singleton.per1.95ci<-paste0("singleton averted in period 1: ", round(averted.singleton.per1,digits=1),
       " (",round(averted.singleton.per1.lower,digits=1),
       "-",round(averted.singleton.per1.upper,digits=1),")")
averted.singleton.per1.day.95ci<-paste0("singleton averted per day in period 1: ", 
                                     round(averted.singleton.per1.day,digits=1),
       " (",round(averted.singleton.per1.lower.day,digits=1),
       "-",round(averted.singleton.per1.upper.day,digits=1),")")

averted.singleton.per2.95ci<-paste0("singleton averted in period 2: ", round(averted.singleton.per2,digits=1),
       " (",round(averted.singleton.per2.lower,digits=1),
       "-",round(averted.singleton.per2.upper,digits=1),")")
averted.singleton.per2.day.95ci<-paste0("singleton averted per day in period 2: ", 
                                     round(averted.singleton.per2.day,digits=1),
       " (",round(averted.singleton.per2.lower.day,digits=1),
       "-",round(averted.singleton.per2.upper.day,digits=1),")")

#TOTAL and 95 CI averted   
tots.averted<-round(mean(cases.averted.all.df.pre$cases.averted.all)+averted.singleton, digits=1)
tots.averted.upper<-round(mean(cases.averted.upper$cases.averted.all)+averted.singleton.upper, digits=1)
tots.averted.lower<-round(mean(cases.averted.lower$cases.averted.all)+averted.singleton.lower, digits=1)
```


## Add to text export
```{r}
cat(paste0("Singletons observed during restrictions: ",
           round(AUC.observed.sing,digits=1)),
    predicted.single.95ci,
    
    averted.single.95ci,
    averted.single.day.95ci,
    
    averted.singleton.per1.95ci,
    averted.singleton.per1.day.95ci,
    
    averted.singleton.per2.95ci,
    averted.singleton.per2.day.95ci,
    
    ## TOTAL CASES AVERTED= sublineages + singeltons
    paste0("TOTAL cases averted, sublin desc+singles: ",
           tots.averted," (",
           tots.averted.lower,"-",
           tots.averted.upper,")"),
    
   file=text.out, append=T,sep="\n")

```

## what were the total cases of variant in Canada and what were the averted cases as a percent of that
```{r}
meta.can.var.country.daily.full3<-read.csv(meta.can.var.country.in)

can.var.cases<- meta.can.var.country.daily.full3 %>% 
  filter(var.WHO==Focal.var)
can.var.cases$date<-as.Date(can.var.cases$date)

## estimated total alpha cases
can.var.total.cases<-round(sum(can.var.cases$avgVOC_cases,na.rm=T)) #324,547
can.var.total.cases.text<-paste0("Total estimated ",Focal.var,"\n cases in Canada: ",can.var.total.cases)

#percentage averted of total
percent.focal.averted<-round(tots.averted/can.var.total.cases*100,digits=1)
percent.focal.averted.lower<-round(tots.averted.lower/can.var.total.cases*100,digits=1)
percent.focal.averted.upper<-round(tots.averted.upper/can.var.total.cases*100,digits=1)

## Plot cases with overlay for flight ban
y.lim2<-c(0,(ceiling(max(can.var.cases$avgVOC_cases,na.rm=T))+800))

p.can.var.cases<-ggplot(can.var.cases)+
    annotate(geom="rect",xmin = as.Date(int.start), xmax = as.Date(int.end),
             ymin = y.lim2[1], ymax =y.lim2[2],
             color="grey85",size=0,  fill="grey80")+
    pubThemeDate+
    geom_bar(aes(x=date, y=avgVOC_cases),fill=var.col,stat="identity",width=1)+
    scaleDateFlexLess+
    scale_y_continuous(expand=c(0,0))+
    # GlobFillScale+
    theme(legend.position = "none")+
    labs(x=NULL, y=paste0("Average daily ",Focal.var," cases in Canada"))+
      annotate(geom="text",x =( as.Date(int.start)+int.duration/1.5),
             y=(y.lim2[2]/100)*99, vjust=1, hjust=0.5,
             label=int.descrip,fontface="italic",color="grey25",size=3)+
    # add annotation for total estimated cases
    annotate(geom="label",x =int.start,
             y=(y.lim2[2]/4)*3, vjust=1, hjust=0.4,
             label=can.var.total.cases.text, size=3)
  
p.can.var.cases
ggsave(paste0(f.out,"canada.var.cases.png"),height=3,width=4,unit="in")

```

## Add to text export
```{r}
cat(str_replace_all(can.var.total.cases.text,"\n",""),
    paste0("Percentage averted of total Canadian cases: ",
           percent.focal.averted,
           " (", percent.focal.averted.lower,"-",
           percent.focal.averted.upper,")"),
    file=text.out, append=T,sep="\n")
```
